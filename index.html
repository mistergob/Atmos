<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Espace de Travail ‚Äî sch√©ma</title>
  <style>
    :root{
      --bg:#f5f6f8; --card:#fff; --text:#111827; --muted:#6b7280; --primary:#cc0000; --ring:rgba(17,24,39,0.08);
      --sidebar-w:260px; --sidebar2-w:0px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";background:var(--bg);color:var(--text);user-select:none;overflow:hidden}

    /* Zone sch√©ma */
    .stage{position:relative;width:calc(100vw - var(--sidebar-w) - var(--sidebar2-w));height:100vh;margin-left:calc(var(--sidebar-w) + var(--sidebar2-w));display:grid;place-items:center}
    .stage.panning, .stage.panning *{cursor:grabbing !important}

    /* Monde pannable + zoomable */
    #world{position:absolute;inset:0;transform-origin:0 0;will-change:transform}

    /* Fils */
    #wires{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}

    /* Cercles */
    .node{position:absolute;width:110px;height:110px;border-radius:9999px;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;text-align:center;padding:10px;box-shadow:0 8px 24px var(--ring);cursor:grab;transition:transform .12s ease,box-shadow .12s ease,filter .12s ease;will-change:transform,left,top}
    .node:active{cursor:grabbing}
    .node:hover{filter:brightness(1.05)}
    .node.selected{outline:3px solid #2563eb;box-shadow:0 0 0 6px rgba(37,99,235,.25),0 8px 24px var(--ring)}
    .node.snap-target{outline:3px dashed #10b981}
    .node.wire-source{outline:3px solid #f59e0b}
    .node.connectable{outline:2px dashed #f59e0b}
    .node .label{pointer-events:none;line-height:1.1;width:100%;max-width:100%;overflow:hidden;word-break:break-word;hyphens:auto}

    /* Menu contextuel g√©n√©rique */
    .menu{position:fixed;display:none;flex-direction:column;min-width:260px;background:var(--card);border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 20px 40px rgba(0,0,0,.15);overflow:hidden;z-index:50}
    .menu button{appearance:none;background:transparent;border:0;text-align:left;padding:12px 14px;font-size:14px;cursor:pointer}
    .menu button:hover{background:#f3f4f6}
    .menu .row{display:flex;align-items:center;gap:10px;padding:10px 12px;border-top:1px solid #e5e7eb}
    .menu .row label{font-size:12px;color:var(--muted)}
    .menu .row input[type="color"]{width:36px;height:28px;border:1px solid #e5e7eb;border-radius:6px;padding:0;background:transparent;cursor:pointer}
    .menu select,.menu input[type="number"]{height:28px;border:1px solid #e5e7eb;border-radius:6px;padding:0 8px;background:transparent}
    .menu .toggle-group{display:flex;gap:8px}
    .menu .toggle{padding:6px 10px;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer}
    .menu .toggle[aria-pressed="true"]{background:#111827;color:#fff}

    /* Toolbar */
    .toolbar{position:fixed;right:16px;top:16px;display:flex;gap:8px;background:var(--card);border:1px solid #e5e7eb;border-radius:14px;padding:8px;box-shadow:0 8px 24px var(--ring);z-index:60}
    .toolbar button{padding:8px 12px;border:0;border-radius:10px;background:#111827;color:#fff;font-weight:600;cursor:pointer}
    .toolbar button.secondary{background:#4b5563}
    .toolbar button.danger{background:#b91c1c}
    .toolbar button.active{outline:2px solid #2563eb}

    /* Menus 1 & 2 */
    .sidebar{position:fixed;left:0;top:0;bottom:0;width:var(--sidebar-w);background:var(--card);border-right:1px solid #e5e7eb;box-shadow:0 8px 24px var(--ring);padding:12px;overflow:auto;z-index:70}
    .sidebar2{left:var(--sidebar-w);width:var(--sidebar2-w);display:none}
    .side-item{width:100%;text-align:left;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#111827;color:#fff;font-weight:700;cursor:pointer;margin-bottom:8px;transition:filter .12s ease}
    .side-item:hover{filter:brightness(1.05)}
    .child-list{list-style:none;padding-left:10px;margin:6px 0 12px}
    .child-list li{padding:6px 8px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;margin-bottom:6px;font-size:13px;cursor:pointer}
    .child-list li:hover{background:#f3f4f6}

    /* Raccourci recentrage coeur */
    .home-btn{position:fixed;right:16px;bottom:16px;width:44px;height:44px;border-radius:9999px;border:1px solid #e5e7eb;background:#fff;box-shadow:0 8px 24px var(--ring);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px;z-index:65}

    /* Pulse */
    @keyframes pulseNode{0%{box-shadow:0 0 0 0 rgba(17,24,39,.35)}100%{box-shadow:0 0 0 6px rgba(17,24,39,0)}}
    .node.pulse{animation:pulseNode 600ms ease-out 2}
  </style>
</head>
<body>
  <!-- Menu 1 -->
  <aside id="sidebar" class="sidebar" aria-label="Navigation">
    <div id="principalList"></div>
  </aside>

  <!-- Menu 2 (visible uniquement apr√®s s√©lection via Menu 1) -->
  <aside id="actions" class="sidebar sidebar2" aria-label="Actions du cercle">
    <div id="selectedInfo" style="font-size:12px;color:var(--muted);margin:0 0 8px;">Aucun cercle s√©lectionn√©</div>
    <div class="row" aria-label="Titre (panneau)">
      <label for="titleInput2">Titre</label>
      <input id="titleInput2" type="text" placeholder="Nom du cercle" style="flex:1; height:28px; border:1px solid #e5e7eb; border-radius:6px; padding:0 8px;" />
    </div>
    <button id="actAddPrincipal" class="side-item" type="button">‚ûï Cercle principal</button>
    <button id="actAddSecondary" class="side-item" type="button">‚ûï Cercle secondaire</button>
    <button id="actWire" class="side-item" type="button">üîó Connecter √†‚Ä¶</button>
    <div class="row" aria-label="Couleur (panneau)">
      <label for="colorPicker2">Couleur</label>
      <input id="colorPicker2" type="color" value="#CC0000" />
    </div>
    <div class="row" aria-label="Police (panneau)">
      <label for="fontSelect2">Police</label>
      <select id="fontSelect2">
        <option value="system-ui">Syst√®me</option>
        <option value="Arial">Arial</option>
        <option value="Roboto">Roboto</option>
        <option value="Georgia">Georgia</option>
        <option value="'Times New Roman'">Times New Roman</option>
        <option value="'Courier New'">Courier New</option>
      </select>
    </div>
    <div class="row" aria-label="Taille max (panneau)">
      <label for="fontSizeMax2">Taille max</label>
      <input id="fontSizeMax2" type="number" min="6" max="72" step="1" value="32" />
    </div>
    <div class="row" aria-label="Style (panneau)">
      <label>Style</label>
      <div class="toggle-group">
        <button type="button" id="boldBtn2" class="toggle" aria-pressed="true">Gras</button>
        <button type="button" id="italicBtn2" class="toggle" aria-pressed="false">Italique</button>
        <button type="button" id="underlineBtn2" class="toggle" aria-pressed="false">Soulign√©</button>
      </div>
    </div>
    <button id="actCenter" class="side-item" type="button">üéØ Centrer sur le cercle</button>
    <button id="actDelete" class="side-item" type="button" style="background:#b91c1c">üóëÔ∏è Supprimer le cercle</button>
  </aside>

  <!-- Zone sch√©ma -->
  <div id="stage" class="stage" aria-label="Espace de travail">
    <div id="world">
      <svg id="wires" aria-hidden="true"></svg>
      <div id="main-node" class="node" data-id="node-0" style="left: calc(50% - 55px); top: calc(50% - 55px);">
        <span class="label">Cercle principal</span>
      </div>
    </div>
  </div>

  <!-- Menu 3 (g√©n√©rique) -->
  <div id="menu" class="menu" role="menu" aria-hidden="true">
    <button data-action="add">‚ûï Cercle principal</button>
    <button data-action="addSmall">‚ûï Cercle secondaire</button>
    <button data-action="wire">üîó Connecter √†‚Ä¶</button>
    <button data-action="color">üé® Modifier la couleur</button>
    <div class="row" aria-label="S√©lecteur de couleur">
      <label for="colorPicker">Couleur</label>
      <input id="colorPicker" type="color" value="#CC0000" />
    </div>
    <div class="row" aria-label="Police">
      <label for="fontSelect">Police</label>
      <select id="fontSelect">
        <option value="system-ui">Syst√®me</option>
        <option value="Arial">Arial</option>
        <option value="Roboto">Roboto</option>
        <option value="Georgia">Georgia</option>
        <option value="'Times New Roman'">Times New Roman</option>
        <option value="'Courier New'">Courier New</option>
      </select>
    </div>
    <div class="row" aria-label="Taille de police">
      <label for="fontSizeMax">Taille max</label>
      <input id="fontSizeMax" type="number" min="6" max="72" step="1" value="32" />
    </div>
    <div class="row" aria-label="Style de texte">
      <label>Style</label>
      <div class="toggle-group">
        <button type="button" id="boldBtn" class="toggle" aria-pressed="true">Gras</button>
        <button type="button" id="italicBtn" class="toggle" aria-pressed="false">Italique</button>
        <button type="button" id="underlineBtn" class="toggle" aria-pressed="false">Soulign√©</button>
      </div>
    </div>
    <button data-action="center">üéØ Centrer sur le cercle</button>
    <button data-action="rename">‚úèÔ∏è Renommer le cercle</button>
    <button data-action="delete">üóëÔ∏è Supprimer le cercle</button>
  </div>

  <!-- Menu 4 (c≈ìur) : copie du Menu 3 -->
  <div id="menuHeart" class="menu" role="menu" aria-hidden="true">
    <button data-action="add">‚ûï Cercle principal</button>
    <button data-action="addSmall">‚ûï Cercle secondaire</button>
    <button data-action="wire">üîó Connecter √†‚Ä¶</button>
    <button data-action="color">üé® Modifier la couleur</button>
    <div class="row" aria-label="S√©lecteur de couleur">
      <label for="colorPickerH">Couleur</label>
      <input id="colorPickerH" type="color" value="#CC0000" />
    </div>
    <div class="row" aria-label="Police">
      <label for="fontSelectH">Police</label>
      <select id="fontSelectH">
        <option value="system-ui">Syst√®me</option>
        <option value="Arial">Arial</option>
        <option value="Roboto">Roboto</option>
        <option value="Georgia">Georgia</option>
        <option value="'Times New Roman'">Times New Roman</option>
        <option value="'Courier New'">Courier New</option>
      </select>
    </div>
    <div class="row" aria-label="Taille de police">
      <label for="fontSizeMaxH">Taille max</label>
      <input id="fontSizeMaxH" type="number" min="6" max="72" step="1" value="32" />
    </div>
    <div class="row" aria-label="Style de texte">
      <label>Style</label>
      <div class="toggle-group">
        <button type="button" id="boldBtnH" class="toggle" aria-pressed="true">Gras</button>
        <button type="button" id="italicBtnH" class="toggle" aria-pressed="false">Italique</button>
        <button type="button" id="underlineBtnH" class="toggle" aria-pressed="false">Soulign√©</button>
      </div>
    </div>
    <button data-action="center">üéØ Centrer sur le cercle</button>
    <button data-action="rename">‚úèÔ∏è Renommer le cercle</button>
    <button data-action="delete">üóëÔ∏è Supprimer le cercle</button>
  </div>

  <!-- Outils -->
  <div class="toolbar" aria-label="Actions rapides">
    <button id="wireModeBtn" class="secondary">C√¢bler (C)</button>
    <button id="exportBtn">Exporter JSON</button>
    <button id="importBtn" class="secondary">Importer JSON</button>
    <button id="resetBtn" class="danger">R√©initialiser</button>
    <input id="fileInput" type="file" accept="application/json" style="display:none" />
  </div>

  <!-- Bouton recentrer c≈ìur -->
  <button id="homeBtn" class="home-btn" title="Recentrer sur le c≈ìur">‚ô•</button>

  <script>
    /* Elements */
    const stage = document.getElementById('stage');
    const world = document.getElementById('world');
    const svg = document.getElementById('wires');
    const menu = document.getElementById('menu');           // Menu 3
    const menuHeart = document.getElementById('menuHeart'); // Menu 4
    const mainNode = document.getElementById('main-node');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const resetBtn = document.getElementById('resetBtn');
    const fileInput = document.getElementById('fileInput');
    const homeBtn = document.getElementById('homeBtn');
    const wireModeBtn = document.getElementById('wireModeBtn');

    /* Menu 3 controls */
    const colorPicker = document.getElementById('colorPicker');
    const fontSelect = document.getElementById('fontSelect');
    const fontSizeMax = document.getElementById('fontSizeMax');
    const boldBtn = document.getElementById('boldBtn');
    const italicBtn = document.getElementById('italicBtn');
    const underlineBtn = document.getElementById('underlineBtn');

    /* Menu 4 controls (coeur) */
    const colorPickerH = document.getElementById('colorPickerH');
    const fontSelectH = document.getElementById('fontSelectH');
    const fontSizeMaxH = document.getElementById('fontSizeMaxH');
    const boldBtnH = document.getElementById('boldBtnH');
    const italicBtnH = document.getElementById('italicBtnH');
    const underlineBtnH = document.getElementById('underlineBtnH');

    /* Menus 1/2 */
    const principalList = document.getElementById('principalList');
    const actionsPanel = document.getElementById('actions');
    const selectedInfo = document.getElementById('selectedInfo');
    const titleInput2 = document.getElementById('titleInput2');
    const actAddPrincipal = document.getElementById('actAddPrincipal');
    const actAddSecondary = document.getElementById('actAddSecondary');
    const actWire = document.getElementById('actWire');
    const actCenter = document.getElementById('actCenter');
    const actDelete = document.getElementById('actDelete');
    const colorPicker2 = document.getElementById('colorPicker2');
    const fontSelect2 = document.getElementById('fontSelect2');
    const fontSizeMax2 = document.getElementById('fontSizeMax2');
    const boldBtn2 = document.getElementById('boldBtn2');
    const italicBtn2 = document.getElementById('italicBtn2');
    const underlineBtn2 = document.getElementById('underlineBtn2');

    /* State */
    let currentNode = null;
    let idCounter = 1;
    const camera = { x: 0, y: 0, z: 1 };
    const BIG_SIZE = 110, SMALL_SIZE = 55;
    const SNAP_GAP = 12, SNAP_RANGE = 120;
    const Z_MIN = 0.5, Z_MAX = 2.0;
    let snapHint = null;

    /* C√¢blage */
    const wiring = { active:false, source:null, ghost:null };

    /* Utils */
    const clamp = (v, a, b) => Math.min(Math.max(v, a), b);
    const approxEq = (a,b,eps=0.5)=>Math.abs(a-b)<=eps;
    const stageRect = () => stage.getBoundingClientRect();
    const centerInWorld = (el) => ({ x: el.offsetLeft + el.offsetWidth/2, y: el.offsetTop + el.offsetHeight/2 });
    function applyCamera(){ world.style.transform = `translate(${camera.x}px, ${camera.y}px) scale(${camera.z})`; }
    function pointerToWorld(e){ const sr=stageRect(); return { wx:(e.clientX - sr.left - camera.x)/camera.z, wy:(e.clientY - sr.top - camera.y)/camera.z }; }

    /* Couleur utils */
    function normalizeHex(input){ if(!input) return null; let m=String(input).match(/^#?([0-9a-fA-F]{6})$/); if(m) return '#'+m[1].toUpperCase(); m=String(input).match(/^#?([0-9a-fA-F]{3})$/); if(m) return '#'+m[1].split('').map(c=>c+c).join('').toUpperCase(); return null; }
    function toHex(input){ if(!input) return null; const hex=String(input).trim().match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i); if(hex){ const h=hex[1]; return '#'+(h.length===3?h.split('').map(c=>c+c).join(''):h).toUpperCase(); } const m=String(input).match(/rgba?\(\s*([0-9.]+)[,\s]+([0-9.]+)[,\s]+([0-9.]+)/i); if(!m) return null; const [r,g,b]=[m[1],m[2],m[3]].map(v=>Math.max(0,Math.min(255,Math.round(parseFloat(v))))); return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('').toUpperCase(); }

    /* Lignes */
    const qLines = ()=> svg.querySelectorAll('line');
    function updateLineEnds(line){
      const from = world.querySelector(`[data-id="${line.dataset.from}"]`);
      const to   = world.querySelector(`[data-id="${line.dataset.to}"]`);
      if(!from||!to) return;
      const c1 = centerInWorld(from), c2 = centerInWorld(to);
      line.setAttribute('x1', c1.x); line.setAttribute('y1', c1.y);
      line.setAttribute('x2', c2.x); line.setAttribute('y2', c2.y);
    }
    function updateLinesFor(el){ const id=el.dataset.id; qLines().forEach(l=>{ if(l.dataset.from===id||l.dataset.to===id) updateLineEnds(l); }); }
    function updateAllLines(){ qLines().forEach(updateLineEnds); }
    function findLine(aId,bId){ for(const l of qLines()){ if((l.dataset.from===aId&&l.dataset.to===bId)||(l.dataset.from===bId&&l.dataset.to===aId)) return l; } return null; }
    function createLine(fromEl,toEl){ const line=document.createElementNS('http://www.w3.org/2000/svg','line'); line.setAttribute('stroke','#111827'); line.setAttribute('stroke-width','2'); line.setAttribute('stroke-linecap','round'); line.dataset.from=fromEl.dataset.id; line.dataset.to=toEl.dataset.id; svg.appendChild(line); updateLineEnds(line); return line; }

    /* Label autosize */
    function fitLabelToNode(node){
      const label=node.querySelector('.label'); if(!label) return;
      label.style.width='100%'; label.style.maxWidth='100%'; label.style.whiteSpace='normal'; label.style.overflow='hidden'; label.style.wordBreak='break-word';
      const cs=getComputedStyle(node);
      const padX=(parseFloat(cs.paddingLeft)||0)+(parseFloat(cs.paddingRight)||0);
      const padY=(parseFloat(cs.paddingTop)||0)+(parseFloat(cs.paddingBottom)||0);
      const contentW=Math.max(0,node.clientWidth-padX);
      const contentH=Math.max(0,node.clientHeight-padY);
      const cap=parseFloat(node.dataset.maxFont);
      let low=6, high=Math.max(6,Math.floor(Math.min(contentH, Number.isFinite(cap)?cap:contentH))), best=low;
      if(!label.textContent.trim()){ label.style.fontSize=Math.min(16,high)+'px'; return; }
      for(let i=0;i<12 && low<=high;i++){ const mid=Math.floor((low+high)/2); label.style.fontSize=mid+'px'; const fits=label.scrollWidth<=contentW && label.scrollHeight<=contentH; if(fits){ best=mid; low=mid+1; } else { high=mid-1; } }
      label.style.fontSize=best+'px';
    }
    const fitAllLabels=()=> world.querySelectorAll('.node').forEach(fitLabelToNode);

    /* Menu 2 (strict via Menu 1) */
    function showActionsPanel(show){
      const root=document.documentElement;
      actionsPanel.style.display = show ? 'block' : 'none';
      root.style.setProperty('--sidebar2-w', show ? '260px' : '0px');
    }
    function enableActionPanel(enabled){
      const ctrls=actionsPanel.querySelectorAll('button,select,input');
      ctrls.forEach(el=>{ el.disabled=!enabled; if(!enabled && el.classList.contains('toggle')) el.setAttribute('aria-pressed','false'); });
      selectedInfo.textContent = enabled && currentNode ? (currentNode.querySelector('.label')?.textContent || currentNode.dataset.id) : 'Aucun cercle s√©lectionn√©';
      titleInput2.value = enabled && currentNode ? (currentNode.querySelector('.label')?.textContent || '') : '';
    }
    function syncActionPanel(){
      if(!currentNode){ enableActionPanel(false); return; }
      enableActionPanel(true);
      const hex = toHex(getComputedStyle(currentNode).backgroundColor) || '#CC0000';
      colorPicker.value=hex; colorPicker2.value=hex; colorPickerH.value=hex;
      const label=currentNode.querySelector('.label');
      const fam = label.style.fontFamily && Array.from(fontSelect.options).some(o=>o.value===label.style.fontFamily) ? label.style.fontFamily : 'system-ui';
      fontSelect.value=fam; fontSelect2.value=fam; fontSelectH.value=fam;
      const cap=currentNode.dataset.maxFont || '32'; fontSizeMax.value=cap; fontSizeMax2.value=cap; fontSizeMaxH.value=cap;
      const cs=getComputedStyle(label);
      const fw=parseInt(cs.fontWeight,10); const isBold=(fw>=600)||cs.fontWeight==='bold';
      const isItalic=cs.fontStyle==='italic';
      const isUnderline=(cs.textDecorationLine||cs.textDecoration||'').includes('underline');
      [boldBtn,boldBtn2,boldBtnH].forEach(b=>b.setAttribute('aria-pressed', isBold?'true':'false'));
      [italicBtn,italicBtn2,italicBtnH].forEach(b=>b.setAttribute('aria-pressed', isItalic?'true':'false'));
      [underlineBtn,underlineBtn2,underlineBtnH].forEach(b=>b.setAttribute('aria-pressed', isUnderline?'true':'false'));
    }
    function setCurrentNode(node,{fromMenu1=false}={}){
      world.querySelectorAll('.node.selected').forEach(n=>n.classList.remove('selected'));
      currentNode=node||null;
      if(currentNode) currentNode.classList.add('selected');
      syncActionPanel();
      showActionsPanel(fromMenu1); // Menu 2 strict
    }

    /* Cam√©ra */
    function centerOnNode(node){
      if(!node) return;
      const sr=stageRect();
      const c=centerInWorld(node);
      camera.x = sr.width/2  - c.x*camera.z;
      camera.y = sr.height/2 - c.y*camera.z;
      applyCamera();
      node.classList.add('pulse'); setTimeout(()=>node.classList.remove('pulse'),800);
    }
    function centerOnCurrent(){ if(currentNode) centerOnNode(currentNode); }
    homeBtn.addEventListener('click',()=> centerOnNode(mainNode));

    /* D√©placement & snap */
    function isPrincipalNode(n){ const w=parseFloat(getComputedStyle(n).width)||0; return approxEq(w,BIG_SIZE); }
    function isSecondaryNode(n){ const w=parseFloat(getComputedStyle(n).width)||0; return approxEq(w,SMALL_SIZE); }
    function neighborsOf(id){
      const res=[]; qLines().forEach(l=>{ if(l.dataset.from===id) res.push(l.dataset.to); else if(l.dataset.to===id) res.push(l.dataset.from); });
      return Array.from(new Set(res));
    }
    function secondariesOfPrincipal(principalEl){
      const ids = neighborsOf(principalEl.dataset.id);
      return ids.map(id=>world.querySelector(`[data-id="${id}"]`)).filter(Boolean).filter(isSecondaryNode);
    }
    function nearestPrincipal(toNode){
      const sC=centerInWorld(toNode); let best=null,bestDist=Infinity;
      world.querySelectorAll('.node').forEach(n=>{ if(!isPrincipalNode(n)||n===toNode) return; const c=centerInWorld(n); const d=Math.hypot(sC.x-c.x,sC.y-c.y); if(d<bestDist){ best=n; bestDist=d; }});
      return {node:best, dist:bestDist};
    }
    function snapSecondaryToPrincipal(sec, principal){
      const pC=centerInWorld(principal); const sW=sec.offsetWidth, sH=sec.offsetHeight;
      const angle=Math.atan2( (sec.offsetTop + sH/2) - pC.y, (sec.offsetLeft + sW/2) - pC.x ) || 0;
      const radius = BIG_SIZE/2 + sW/2 + SNAP_GAP;
      const cx = pC.x + radius*Math.cos(angle);
      const cy = pC.y + radius*Math.sin(angle);
      sec.style.left = (cx - sW/2) + 'px';
      sec.style.top  = (cy - sH/2) + 'px';
      updateLinesFor(sec);
    }
    function ensureSinglePrincipalEdge(sec, principal){
      const sid=sec.dataset.id, pid=principal.dataset.id;
      qLines().forEach(l=>{
        if(l.dataset.from===sid||l.dataset.to===sid){
          const otherId = l.dataset.from===sid ? l.dataset.to : l.dataset.from;
          const otherEl = world.querySelector(`[data-id="${otherId}"]`);
          if(otherEl && isPrincipalNode(otherEl) && otherId!==pid) l.remove();
        }
      });
      if(!findLine(sid,pid)) createLine(principal,sec);
    }

    function enableDrag(node){
      if(node._dragEnabled) return;
      let offsetXw=0, offsetYw=0, dragging=false, prevLeft=0, prevTop=0;

      node.addEventListener('pointerdown',(e)=>{
        if(e.button!==0) return; // drag uniquement clic gauche
        // Si mode c√¢blage actif ‚Üí s√©lection source/connexion, pas de drag.
        if(wiring.active){
          e.preventDefault(); e.stopPropagation();
          if(!wiring.source){
            setCurrentNode(node,{fromMenu1:false});
            startWiring(node); // d√©finit la source et cr√©e la ligne fant√¥me
          }else{
            attemptConnect(node); // essaie de relier source ‚Üí node
          }
          return;
        }

        setCurrentNode(node,{fromMenu1:false});
        closeMenu(menu); closeMenu(menuHeart);
        node.setPointerCapture(e.pointerId);
        const rect=node.getBoundingClientRect();
        offsetXw = (e.clientX - rect.left) / camera.z;
        offsetYw = (e.clientY - rect.top)  / camera.z;
        prevLeft = parseFloat(node.style.left)||0;
        prevTop  = parseFloat(node.style.top)||0;
        dragging=true;
      });

      node.addEventListener('pointermove',(ev)=>{
        if(!dragging) return;
        const sr=stageRect();
        const worldX = (ev.clientX - sr.left - camera.x)/camera.z;
        const worldY = (ev.clientY - sr.top  - camera.y)/camera.z;
        const newLeft = worldX - offsetXw;   // d√©placement libre (peut devenir n√©gatif)
        const newTop  = worldY - offsetYw;

        const dx = newLeft - prevLeft;
        const dy = newTop  - prevTop;

        node.style.left=newLeft+'px';
        node.style.top =newTop +'px';
        updateLinesFor(node);
        fitLabelToNode(node);

        // Si principal ‚Üí faire suivre ses secondaires
        if(isPrincipalNode(node) && (dx!==0 || dy!==0)){
          secondariesOfPrincipal(node).forEach(sec=>{
            sec.style.left = ((parseFloat(sec.style.left)||0) + dx) + 'px';
            sec.style.top  = ((parseFloat(sec.style.top)||0) + dy) + 'px';
            updateLinesFor(sec);
          });
        }

        // Indice d'accroche pour un secondaire en drag
        if(isSecondaryNode(node)){
          const {node:pri, dist} = nearestPrincipal(node);
          if(snapHint && snapHint!==pri) snapHint.classList.remove('snap-target');
          if(pri && dist <= SNAP_RANGE){ pri.classList.add('snap-target'); snapHint=pri; } else { if(snapHint){ snapHint.classList.remove('snap-target'); snapHint=null; } }
        }

        prevLeft = newLeft;
        prevTop  = newTop;
      });

      node.addEventListener('pointerup',(e)=>{
        if(!dragging) return;
        dragging=false; node.releasePointerCapture(e.pointerId);
        if(isSecondaryNode(node)){
          const {node:pri, dist} = nearestPrincipal(node);
          if(pri && dist <= SNAP_RANGE){ snapSecondaryToPrincipal(node, pri); ensureSinglePrincipalEdge(node, pri); }
          if(snapHint){ snapHint.classList.remove('snap-target'); snapHint=null; }
        }
        saveState();
      });

      node.addEventListener('contextmenu',(e)=>{
        e.preventDefault();
        if(node.id === 'main-node') openMenuAt(menuHeart, e, node);
        else openMenuAt(menu, e, node);
      });

      node._dragEnabled=true;
    }

    /* Ajout cercles */
    function addNodeNear(target){
      const sr=stageRect();
      const tRect=target.getBoundingClientRect();
      const tW=target.offsetWidth, tH=target.offsetHeight;
      const left = ((tRect.left - sr.left - camera.x)/camera.z) + tW + 30;
      const top  = ((tRect.top  - sr.top  - camera.y)/camera.z) + tH + 30;
      const node=document.createElement('div'); node.className='node'; node.dataset.id=`node-${idCounter++}`;
      Object.assign(node.style,{left:left+'px',top:top+'px',width:BIG_SIZE+'px',height:BIG_SIZE+'px',backgroundColor: toHex(getComputedStyle(target).backgroundColor) || '#CC0000'});
      node.innerHTML='<span class="label">Cercle principal</span>';
      world.appendChild(node); enableDrag(node); fitLabelToNode(node); createLine(target,node); setCurrentNode(node,{fromMenu1:false}); saveState(); return node;
    }
    function addNodeNearScaled(target){
      const sr=stageRect();
      const tRect=target.getBoundingClientRect();
      const tW=target.offsetWidth, tH=target.offsetHeight;
      const left = ((tRect.left - sr.left - camera.x)/camera.z) + tW + 30;
      const top  = ((tRect.top  - sr.top  - camera.y)/camera.z) + tH + 30;
      const node=document.createElement('div'); node.className='node'; node.dataset.id=`node-${idCounter++}`;
      Object.assign(node.style,{left:left+'px',top:top+'px',width:SMALL_SIZE+'px',height:SMALL_SIZE+'px',backgroundColor: toHex(getComputedStyle(target).backgroundColor) || '#CC0000'});
      node.innerHTML='<span class="label">Cercle secondaire</span>';
      world.appendChild(node); enableDrag(node); fitLabelToNode(node); createLine(target,node); setCurrentNode(node,{fromMenu1:false}); saveState(); return node;
    }

    /* Menus contextuels (3 et 4) */
    function openMenuAt(whichMenu, event, node){
      if(!event){ whichMenu.style.display='none'; whichMenu.setAttribute('aria-hidden','true'); return; }
      setCurrentNode(node,{fromMenu1:false});
      // sync
      const hex=toHex(getComputedStyle(currentNode).backgroundColor)||'#CC0000';
      (whichMenu.querySelector('input[type="color"]')||{}).value = hex;
      const lbl=currentNode.querySelector('.label');
      whichMenu.querySelectorAll('select').forEach(sel=>{
        const fam = lbl.style.fontFamily && Array.from(sel.options).some(o=>o.value===lbl.style.fontFamily)? lbl.style.fontFamily : 'system-ui';
        sel.value=fam;
      });
      const sizeInput = whichMenu.querySelector('input[type="number"]'); if(sizeInput) sizeInput.value = currentNode.dataset.maxFont || '32';
      const cs=getComputedStyle(lbl); const fw=parseInt(cs.fontWeight,10); const isBold=(fw>=600)||cs.fontWeight==='bold'; const isIt=cs.fontStyle==='italic'; const isUl=(cs.textDecorationLine||cs.textDecoration||'').includes('underline');
      const setPressed=(sel, on)=> sel && sel.setAttribute('aria-pressed', on?'true':'false');
      setPressed(whichMenu.querySelector('#boldBtn')||whichMenu.querySelector('#boldBtnH'), isBold);
      setPressed(whichMenu.querySelector('#italicBtn')||whichMenu.querySelector('#italicBtnH'), isIt);
      setPressed(whichMenu.querySelector('#underlineBtn')||whichMenu.querySelector('#underlineBtnH'), isUl);

      // position
      menu.style.display='none'; menuHeart.style.display='none';
      whichMenu.style.display='flex'; whichMenu.setAttribute('aria-hidden','false');
      const mRect=whichMenu.getBoundingClientRect(); const vw=innerWidth,vh=innerHeight; const x=Math.min(event.clientX,vw-mRect.width-8); const y=Math.min(event.clientY,vh-mRect.height-8); whichMenu.style.left=x+'px'; whichMenu.style.top=y+'px'; event.stopPropagation();
    }
    function closeMenu(whichMenu){ whichMenu.style.display='none'; whichMenu.setAttribute('aria-hidden','true'); }
    document.addEventListener('click',(e)=>{ if(!menu.contains(e.target)) closeMenu(menu); if(!menuHeart.contains(e.target)) closeMenu(menuHeart); });

    function applyColor(hex){ if(!currentNode) return; const v=normalizeHex(hex); if(!v) return; currentNode.style.backgroundColor=v; [colorPicker,colorPicker2,colorPickerH].forEach(el=>{ if(el) el.value=v; }); saveState(); }
    function setFamily(val){ if(!currentNode) return; const l=currentNode.querySelector('.label'); l.style.fontFamily=val; [fontSelect,fontSelect2,fontSelectH].forEach(el=>{ if(el) el.value=val; }); fitLabelToNode(currentNode); saveState(); }
    function setMax(v){ if(!currentNode) return; const min=6,max=72,val=Math.max(min,Math.min(max,parseFloat(v)||min)); currentNode.dataset.maxFont=String(val); [fontSizeMax,fontSizeMax2,fontSizeMaxH].forEach(el=>{ if(el) el.value=val; }); fitLabelToNode(currentNode); saveState(); }
    function togglePressed(btn){ const newV = btn.getAttribute('aria-pressed')==='true'?'false':'true'; btn.setAttribute('aria-pressed',newV); return newV==='true'; }

    // Menu 3 handlers
    menu.addEventListener('click',(e)=>{
      const btn=e.target.closest('button'); if(!btn||!currentNode) return;
      const action=btn.dataset.action;
      if(action==='add'){ addNodeNear(currentNode); closeMenu(menu); return; }
      if(action==='addSmall'){ addNodeNearScaled(currentNode); closeMenu(menu); return; }
      if(action==='wire'){ startWiring(currentNode); closeMenu(menu); return; }
      if(action==='color'){ colorPicker.focus(); colorPicker.click(); return; }
      if(action==='center'){ centerOnCurrent(); closeMenu(menu); return; }
      if(action==='rename'){ const label=currentNode.querySelector('.label'); const name=prompt('Entrez un nouveau nom :', label.textContent.trim()); if(name){ label.textContent=name; fitLabelToNode(currentNode); saveState(); } closeMenu(menu); return; }
      if(action==='delete'){ if(currentNode.id==='main-node'||currentNode.dataset.id==='node-0'){ alert('Le cercle principal ne peut pas √™tre supprim√©.'); } else { qLines().forEach(l=>{ if(l.dataset.from===currentNode.dataset.id||l.dataset.to===currentNode.dataset.id) l.remove(); }); currentNode.remove(); saveState(); } closeMenu(menu); return; }
    });
    colorPicker.addEventListener('input',(e)=> applyColor(e.target.value));
    fontSelect.addEventListener('change',(e)=> setFamily(e.target.value));
    fontSizeMax.addEventListener('input',(e)=> setMax(e.target.value));
    boldBtn.addEventListener('click',(e)=>{ e.stopPropagation(); const on=togglePressed(boldBtn); currentNode.querySelector('.label').style.fontWeight = on?'700':'400'; fitLabelToNode(currentNode); saveState(); });
    italicBtn.addEventListener('click',(e)=>{ e.stopPropagation(); const on=togglePressed(italicBtn); currentNode.querySelector('.label').style.fontStyle = on?'italic':'normal'; fitLabelToNode(currentNode); saveState(); });
    underlineBtn.addEventListener('click',(e)=>{ e.stopPropagation(); const on=togglePressed(underlineBtn); currentNode.querySelector('.label').style.textDecoration = on?'underline':'none'; fitLabelToNode(currentNode); saveState(); });

    // Menu 4 (c≈ìur) handlers
    menuHeart.addEventListener('click',(e)=>{
      const btn=e.target.closest('button'); if(!btn||!currentNode) return;
      const action=btn.dataset.action;
      if(action==='add'){ addNodeNear(currentNode); closeMenu(menuHeart); return; }
      if(action==='addSmall'){ addNodeNearScaled(currentNode); closeMenu(menuHeart); return; }
      if(action==='wire'){ startWiring(currentNode); closeMenu(menuHeart); return; }
      if(action==='color'){ colorPickerH.focus(); colorPickerH.click(); return; }
      if(action==='center'){ centerOnCurrent(); closeMenu(menuHeart); return; }
      if(action==='rename'){ const label=currentNode.querySelector('.label'); const name=prompt('Entrez un nouveau nom :', label.textContent.trim()); if(name){ label.textContent=name; fitLabelToNode(currentNode); saveState(); } closeMenu(menuHeart); return; }
      if(action==='delete'){ if(currentNode.id==='main-node'||currentNode.dataset.id==='node-0'){ alert('Le cercle principal ne peut pas √™tre supprim√©.'); } else { qLines().forEach(l=>{ if(l.dataset.from===currentNode.dataset.id||l.dataset.to===currentNode.dataset.id) l.remove(); }); currentNode.remove(); saveState(); } closeMenu(menuHeart); return; }
    });
    colorPickerH.addEventListener('input',(e)=> applyColor(e.target.value));
    fontSelectH.addEventListener('change',(e)=> setFamily(e.target.value));
    fontSizeMaxH.addEventListener('input',(e)=> setMax(e.target.value));
    boldBtnH.addEventListener('click',(e)=>{ e.stopPropagation(); const on=togglePressed(boldBtnH); currentNode.querySelector('.label').style.fontWeight = on?'700':'400'; fitLabelToNode(currentNode); saveState(); });
    italicBtnH.addEventListener('click',(e)=>{ e.stopPropagation(); const on=togglePressed(italicBtnH); currentNode.querySelector('.label').style.fontStyle = on?'italic':'normal'; fitLabelToNode(currentNode); saveState(); });
    underlineBtnH.addEventListener('click',(e)=>{ e.stopPropagation(); const on=togglePressed(underlineBtnH); currentNode.querySelector('.label').style.textDecoration = on?'underline':'none'; fitLabelToNode(currentNode); saveState(); });

    /* Menu 1 (principaux + secondaires) */
    function stylePrincipalButtonFromNode(btn, node){
      const col = toHex(getComputedStyle(node).backgroundColor) || '#111827';
      btn.style.backgroundColor = col;
      const h=col.slice(1); const r=parseInt(h.substr(0,2),16), g=parseInt(h.substr(2,2),16), b=parseInt(h.substr(4,2),16);
      const yiq=(r*299+g*587+b*114)/1000;
      btn.style.color = yiq>=186 ? '#111827' : '#ffffff';
      btn.style.borderColor = '#e5e7eb';
    }
    function populateChildren(principalId, ul){
      ul.innerHTML='';
      const seconds=neighborsOf(principalId).map(id=>world.querySelector(`[data-id="${id}"]`)).filter(Boolean).filter(isSecondaryNode);
      if(seconds.length===0){ const li=document.createElement('li'); li.textContent='Aucun cercle secondaire'; li.style.color='#6b7280'; li.style.borderStyle='dashed'; ul.appendChild(li); return; }
      seconds.forEach(n=>{ const li=document.createElement('li'); li.textContent=n.querySelector('.label')?.textContent || n.dataset.id; li.addEventListener('click',()=>{ setCurrentNode(n,{fromMenu1:true}); n.classList.add('pulse'); setTimeout(()=>n.classList.remove('pulse'),800); }); ul.appendChild(li); });
    }
    function refreshSidebar(){
      principalList.innerHTML='';
      const principals=Array.from(world.querySelectorAll('.node')).filter(isPrincipalNode);
      principals.forEach(n=>{
        const wrap=document.createElement('div');
        const btn=document.createElement('button'); btn.className='side-item'; btn.type='button';
        btn.textContent=n.querySelector('.label')?.textContent||n.dataset.id;
        stylePrincipalButtonFromNode(btn, n);
        const ul=document.createElement('ul'); ul.className='child-list'; ul.style.display='none';
        btn.addEventListener('click',()=>{ setCurrentNode(n,{fromMenu1:true}); if(ul.style.display==='none'){ populateChildren(n.dataset.id,ul); ul.style.display='block'; } else { ul.style.display='none'; } });
        wrap.appendChild(btn); wrap.appendChild(ul); principalList.appendChild(wrap);
      });
    }

    /* Panneau d‚Äôactions */
    actAddPrincipal.addEventListener('click',()=>{ if(!currentNode) return; addNodeNear(currentNode); });
    actAddSecondary.addEventListener('click',()=>{ if(!currentNode) return; addNodeNearScaled(currentNode); });
    actWire.addEventListener('click',()=>{ if(!currentNode) return; startWiring(currentNode); });
    actCenter.addEventListener('click',()=> centerOnCurrent());
    actDelete.addEventListener('click',()=>{ if(!currentNode) return; if(currentNode.id==='main-node'||currentNode.dataset.id==='node-0'){ alert('Le cercle principal ne peut pas √™tre supprim√©.'); return; } qLines().forEach(l=>{ if(l.dataset.from===currentNode.dataset.id||l.dataset.to===currentNode.dataset.id) l.remove(); }); currentNode.remove(); currentNode=null; enableActionPanel(false); saveState(); showActionsPanel(false); });

    // Titre direct (Menu 2)
    function applyTitleFromInput(){
      if(!currentNode) return;
      const v = (titleInput2.value||'').trim();
      const label=currentNode.querySelector('.label');
      label.textContent = v;
      fitLabelToNode(currentNode);
      saveState();
      selectedInfo.textContent = v || currentNode.dataset.id;
      refreshSidebar();
    }
    titleInput2.addEventListener('change', applyTitleFromInput);
    titleInput2.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); applyTitleFromInput(); titleInput2.blur(); } });

    /* Toolbar */
    exportBtn.addEventListener('click',()=>{ const data=buildState(); const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='workspace.json'; a.click(); URL.revokeObjectURL(url); });
    importBtn.addEventListener('click',()=> fileInput.click());
    fileInput.addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; if(!f) return; try{ const text=await f.text(); restoreState(JSON.parse(text)); } catch{ alert('Fichier invalide.'); } finally { fileInput.value=''; } });
    resetBtn.addEventListener('click',()=>{ if(!confirm("R√©initialiser l'espace de travail ?")) return; localStorage.removeItem('workspaceState'); qLines().forEach(l=>l.remove()); world.querySelectorAll('.node').forEach(n=>{ if(n!==mainNode) n.remove(); }); mainNode.style.left='calc(50% - 55px)'; mainNode.style.top='calc(50% - 55px)'; mainNode.querySelector('.label').textContent='Cercle principal'; mainNode.style.backgroundColor='var(--primary)'; idCounter=1; camera.x=camera.y=0; camera.z=1; applyCamera(); saveState(); updateAllLines(); fitLabelToNode(mainNode); showActionsPanel(false); });

    /* Pan au bouton milieu (clic roulette) + d√©s√©lection */
    (function setupStagePan(){
      let panActive=false, lastX=0,lastY=0;
      stage.addEventListener('pointerdown',(e)=>{
        if(e.button===1){ // bouton milieu
          e.preventDefault();
          panActive=true; stage.classList.add('panning');
          lastX=e.clientX; lastY=e.clientY;
          stage.setPointerCapture?.(e.pointerId);
          return;
        }
        // clic gauche sur fond (pas de c√¢blage) ‚Üí d√©s√©lection
        if(e.button===0 && !wiring.active && !e.target.closest('.node') && !menu.contains(e.target) && !menuHeart.contains(e.target) && !actionsPanel.contains(e.target) && !document.getElementById('sidebar').contains(e.target)){
          world.querySelectorAll('.node.selected').forEach(n=>n.classList.remove('selected'));
          currentNode=null; enableActionPanel(false); showActionsPanel(false);
        }
        // clic gauche sur fond en c√¢blage ‚Üí annule
        if(e.button===0 && wiring.active && !e.target.closest('.node')) stopWiring();
      });
      stage.addEventListener('pointermove',(e)=>{
        if(panActive){
          const dx=e.clientX-lastX, dy=e.clientY-lastY; camera.x+=dx; camera.y+=dy; applyCamera(); lastX=e.clientX; lastY=e.clientY;
        }
        if(wiring.active && wiring.source && wiring.ghost){
          const {wx,wy} = pointerToWorld(e);
          wiring.ghost.setAttribute('x2', wx); wiring.ghost.setAttribute('y2', wy);
        }
      });
      function endPan(e){
        if(panActive){ panActive=false; stage.classList.remove('panning'); stage.releasePointerCapture?.(e.pointerId); }
      }
      stage.addEventListener('pointerup',endPan);
      stage.addEventListener('pointercancel',endPan);
    })();

    /* Zoom (Ctrl/‚åò + molette) */
    stage.addEventListener('wheel',(e)=>{
      if(!(e.ctrlKey || e.metaKey)) return;
      e.preventDefault();
      const sr=stageRect();
      const mx = e.clientX - sr.left;
      const my = e.clientY - sr.top;
      const wx = (mx - camera.x)/camera.z;
      const wy = (my - camera.y)/camera.z;
      const factor = Math.exp(-e.deltaY * 0.001);
      const zNew = clamp(camera.z * factor, Z_MIN, Z_MAX);
      camera.x = mx - wx * zNew;
      camera.y = my - wy * zNew;
      camera.z = zNew;
      applyCamera();
    }, { passive:false });

    /* ====== Mode C√ÇBLAGE ====== */
    function startWiring(source){
      // active si besoin
      if(!wiring.active){ wiring.active=true; wireModeBtn.classList.add('active'); }
      wiring.source = source;
      // ghost
      if(wiring.ghost) wiring.ghost.remove();
      const c = centerInWorld(source);
      const line=document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('stroke','#2563eb'); line.setAttribute('stroke-width','2'); line.setAttribute('stroke-linecap','round'); line.setAttribute('stroke-dasharray','6 6');
      line.setAttribute('x1', c.x); line.setAttribute('y1', c.y); line.setAttribute('x2', c.x); line.setAttribute('y2', c.y);
      svg.appendChild(line); wiring.ghost=line;
      // highlight
      world.querySelectorAll('.node').forEach(n=>{ if(n===source){ n.classList.add('wire-source'); } else { n.classList.add('connectable'); } });
    }
    function stopWiring(){
      wiring.active=false; wireModeBtn.classList.remove('active');
      if(wiring.ghost){ wiring.ghost.remove(); wiring.ghost=null; }
      wiring.source=null;
      world.querySelectorAll('.node.wire-source').forEach(n=>n.classList.remove('wire-source'));
      world.querySelectorAll('.node.connectable').forEach(n=>n.classList.remove('connectable'));
    }
    function attemptConnect(target){
      if(!wiring.source || target===wiring.source){ // invalide
        stopWiring(); return;
      }
      const a=wiring.source, b=target;
      if(findLine(a.dataset.id,b.dataset.id)){ // d√©j√† reli√©s
        stopWiring(); return;
      }
      createLine(a,b);
      // re-parenting S‚ÜíP
      if(isSecondaryNode(a) && isPrincipalNode(b)) ensureSinglePrincipalEdge(a,b);
      if(isSecondaryNode(b) && isPrincipalNode(a)) ensureSinglePrincipalEdge(b,a);
      saveState(); refreshSidebar();
      stopWiring();
    }

    // Bouton toolbar & clavier
    wireModeBtn.addEventListener('click',()=>{
      if(wiring.active) stopWiring();
      else { wiring.active=true; wireModeBtn.classList.add('active'); /* la 1re s√©lection se fait au clic gauche sur un cercle */ }
    });
    document.addEventListener('keydown',(e)=>{
      if(e.key==='c' || e.key==='C'){ // toggle
        if(wiring.active) stopWiring(); else { wiring.active=true; wireModeBtn.classList.add('active'); }
      }
      if(e.key==='Escape'){ if(wiring.active) stopWiring(); closeMenu(menu); closeMenu(menuHeart); }
    });

    /* Resize */
    window.addEventListener('resize',()=>{ updateAllLines(); fitAllLabels(); });

    /* Persistence */
    function buildState(){
      const nodes=Array.from(world.querySelectorAll('.node')).map(n=>({
        id:n.dataset.id, left:n.style.left||'0px', top:n.style.top||'0px',
        w:parseFloat(getComputedStyle(n).width)||110, h:parseFloat(getComputedStyle(n).height)||110,
        text:n.querySelector('.label')?.textContent||'',
        color: toHex(n.style.backgroundColor || getComputedStyle(n).backgroundColor) || '#CC0000',
        fontFamily:n.querySelector('.label')?.style.fontFamily||'',
        fontWeight:n.querySelector('.label')?.style.fontWeight||'',
        fontStyle:n.querySelector('.label')?.style.fontStyle||'',
        textDecoration:n.querySelector('.label')?.style.textDecoration||'',
        maxFont: n.dataset.maxFont ? parseFloat(n.dataset.maxFont) : null
      }));
      const edges=Array.from(qLines()).map(l=>({from:l.dataset.from,to:l.dataset.to}));
      return { idCounter, nodes, edges };
    }
    function saveState(){ const data=buildState(); localStorage.setItem('workspaceState',JSON.stringify(data)); refreshSidebar(); }
    function restoreState(data){
      qLines().forEach(l=>l.remove());
      world.querySelectorAll('.node').forEach(n=>{ if(n!==mainNode) n.remove(); });
      idCounter=data?.idCounter ?? 1;
      const byId={};
      (data?.nodes||[]).forEach(n=>{
        let node;
        if(n.id==='node-0'){ node=mainNode; }
        else{ node=document.createElement('div'); node.className='node'; node.dataset.id=n.id; world.appendChild(node); enableDrag(node); }
        node.style.left=n.left; node.style.top=n.top;
        if(n.w) node.style.width=n.w+'px';
        if(n.h) node.style.height=n.h+'px';
        const col=normalizeHex(n.color)||toHex(n.color)||'#CC0000'; node.style.backgroundColor=col;
        node.innerHTML='<span class="label"></span>'; const labelEl=node.querySelector('.label');
        labelEl.textContent=n.text||''; if(n.fontFamily) labelEl.style.fontFamily=n.fontFamily; if(n.fontWeight) labelEl.style.fontWeight=n.fontWeight; if(n.fontStyle) labelEl.style.fontStyle=n.fontStyle; if(n.textDecoration) labelEl.style.textDecoration=n.textDecoration; if(n.maxFont) node.dataset.maxFont=String(n.maxFont);
        fitLabelToNode(node); byId[n.id]=node;
      });
      if(!byId['node-0']){ mainNode.dataset.id='node-0'; mainNode.querySelector('.label').textContent='Cercle principal'; byId['node-0']=mainNode; }
      enableDrag(mainNode); fitLabelToNode(mainNode);
      (data?.edges||[]).forEach(e=>{ if(byId[e.from]&&byId[e.to]) createLine(byId[e.from],byId[e.to]); });
      updateAllLines(); refreshSidebar(); saveState(); showActionsPanel(false);
    }

    /* Init */
    enableDrag(mainNode); fitLabelToNode(mainNode); refreshSidebar(); enableActionPanel(false); showActionsPanel(false); applyCamera();
    const saved = localStorage.getItem('workspaceState'); if(saved){ try{ restoreState(JSON.parse(saved)); }catch{} } else { saveState(); }
  </script>
</body>
</html>
