<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ATMOS</title>
  <meta name="color-scheme" content="dark light">
  <!-- CSP (optionnelle) -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; img-src 'self' https://images.unsplash.com data:;
                 style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
                 font-src https://fonts.gstatic.com;
                 script-src 'self' https://cdn.jsdelivr.net;
                 connect-src 'self' https://*.supabase.co;">
  <!-- Polices -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#00eaff; --primary-2:#8a2be2; --text:#e6f7ff; --muted:#9fb3c8;
      --space-img:url("https://images.unsplash.com/photo-1444703686981-a3abbc4d4fe3?q=80&w=1920&auto=format&fit=crop");
      --bg-a:#05060d; --bg-b:#0b1430; --bg-c:#00182a;
      --glow: drop-shadow(0 0 8px rgba(0,234,255,.55)) drop-shadow(0 0 18px rgba(138,43,226,.35));
      --ring: 0 0 0 3px rgba(0,234,255,.35), 0 0 24px rgba(0,234,255,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family:Outfit, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:
        radial-gradient(1200px 800px at 75% 10%, rgba(138,43,226,.18), transparent 60%),
        radial-gradient(900px 700px at 15% 85%, rgba(0,234,255,.12), transparent 55%),
        radial-gradient(700px 500px at 80% 80%, rgba(0,40,80,.35), transparent 60%),
        linear-gradient(120deg, var(--bg-a), var(--bg-b) 40%, var(--bg-c));
      overflow:hidden;
    }
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none; mix-blend-mode:screen; opacity:.15;
      background:
        var(--space-img) center/cover no-repeat,
        radial-gradient(1px 1px at 10% 20%, #fff 40%, transparent 41%),
        radial-gradient(1px 1px at 30% 80%, #fff 40%, transparent 41%),
        radial-gradient(1px 1px at 70% 30%, #fff 40%, transparent 41%),
        radial-gradient(1px 1px at 90% 60%, #fff 40%, transparent 41%);
      animation: twinkle 14s linear infinite;
    }
    @keyframes twinkle{0%,100%{opacity:.12}50%{opacity:.22}}
    .wrap{position:relative; height:100dvh; display:grid; place-items:center; padding:32px; isolation:isolate}
    .aura{position:absolute; inset:0; filter:blur(24px); pointer-events:none; z-index:0;
      background:
        radial-gradient(600px 320px at 50% 35%, rgba(0,234,255,.18), transparent 60%),
        radial-gradient(900px 420px at 50% 70%, rgba(138,43,226,.18), transparent 65%);
      animation: float 18s ease-in-out infinite alternate;
    }
    @keyframes float{from{transform:translateY(-1.5%)}to{transform:translateY(1.5%)}}
    main{z-index:1; width:min(960px,92vw); text-align:center}
    .title{font-family:Orbitron, sans-serif; font-weight:900; letter-spacing:.12em;
      font-size:clamp(36px,6vw,84px); line-height:1; margin:0 0 18px; text-transform:uppercase; color:#eaffff;
      text-shadow:0 0 10px rgba(0,234,255,.45), 0 0 28px rgba(138,43,226,.35), 0 0 64px rgba(0,234,255,.25);
    }
    .subtitle{margin:0 0 24px; color:var(--muted); font-size:clamp(16px,2.2vw,18px)}
    .panel{
      display:inline-flex; flex-direction:column; align-items:center; gap:18px;
      padding:28px; border-radius:20px;
      border:1px solid rgba(255,255,255,.06);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      backdrop-filter: blur(8px);
      box-shadow:0 12px 40px rgba(0,0,0,.35);
      max-width:min(680px,95vw); margin-inline:auto;
    }
    .cta{
      display:inline-flex; align-items:center; gap:12px; padding:14px 22px; border-radius:14px;
      font-weight:600; letter-spacing:.04em; text-decoration:none; color:var(--text);
      background: linear-gradient(#0c1327,#0b1120) padding-box,
                 conic-gradient(from 180deg, rgba(0,234,255,.8), rgba(138,43,226,.8), rgba(0,234,255,.8)) border-box;
      border:1px solid transparent; box-shadow: inset 0 0 0 1px rgba(255,255,255,.04), 0 8px 24px rgba(0,0,0,.45);
      transition: transform .2s ease, box-shadow .2s ease, filter .2s ease;
    }
    .cta .dot{width:10px; height:10px; border-radius:9999px; background:radial-gradient(circle at 30% 30%, #fff, var(--primary) 60%, transparent 65%); box-shadow:0 0 10px var(--primary), 0 0 18px var(--primary)}
    .cta:hover{ transform:translateY(-2px); filter:var(--glow) }
    .cta:focus-visible{ outline:none; box-shadow:var(--ring) }
    .row{display:flex; flex-wrap:wrap; align-items:center; justify-content:center; gap:8px}
    .small{font-size:12px; opacity:.85}
    .busy{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.35); backdrop-filter:blur(2px); z-index:5}
    .busy[data-show="1"]{display:grid}
    .spinner{width:48px; height:48px; border-radius:50%; border:4px solid rgba(255,255,255,.2); border-top-color:#fff; animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (prefers-reduced-motion: reduce){ *{animation:none!important; transition:none!important} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="aura" aria-hidden="true"></div>
    <main>
      <h1 class="title">ATMOS</h1>
      <p class="subtitle">Tableau de bord — Portail principal de votre espace de travail.</p>

      <div class="panel" role="group" aria-label="Navigation principale" aria-live="polite" aria-busy="false">
        <!-- Auth -->
        <div class="row">
          <button class="cta" type="button" id="loginGoogle">Se connecter avec Google</button>
          <button class="cta" type="button" id="loginMicrosoft">Se connecter avec Microsoft</button>
          <button class="cta" type="button" id="logout" style="display:none">Se déconnecter</button>
        </div>
        <div class="small" id="who" aria-live="polite">Non connecté</div>

        <!-- Liens modules -->
        <a class="cta" href="https://mistergob.github.io/sphaira/" target="_blank" rel="noopener noreferrer">
          <span class="dot" aria-hidden="true"></span><span>Entrer dans SPHAIRA</span>
        </a>
        <a class="cta" href="https://mistergob.github.io/Oris/" target="_blank" rel="noopener noreferrer">
          <span class="dot" aria-hidden="true"></span><span>Ouvrir ORIS — Agenda</span>
        </a>
        <a class="cta" href="https://mistergob.github.io/Nexus/" target="_blank" rel="noopener noreferrer">
          <span class="dot" aria-hidden="true"></span><span>Ouvrir NEXUS — Mails</span>
        </a>
      </div>
    </main>
  </div>

  <!-- Busy overlay -->
  <div class="busy" id="busy" role="status" aria-live="assertive" aria-label="Opération en cours">
    <div class="spinner" aria-hidden="true"></div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /* ========= ATMOS (SSO centralisé, sans auto-redirection) =========
       - Pas de redirection vers un module sauf si ?r= est présent (cas SSO depuis un module)
       - Session partagée via localStorage + storageKey identique (même origin)
       - Google: scopes Gmail + Calendar dès le bouton, sans prompt forcé
    ================================================================== */

    // === Config projet (identique NEXUS/ORIS/SPHAIRA) ===
    const PROJECT_REF = "jlfvbggzdkkwrmpsamvz";
    const SUPABASE_URL = `https://${PROJECT_REF}.supabase.co`;
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpsZnZiZ2d6ZGtrd3JtcHNhbXZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyNjUyNjMsImV4cCI6MjA3Mjg0MTI2M30.kDbtNVQfHEVxRbA8jsAfLu7-6kDioTCG-nWVQ91gJIs";
    const STORAGE_KEY = `sb-${PROJECT_REF}-auth-token`;

    // === Scopes Google (centralisés) ===
    const FULL_GOOGLE_SCOPES = [
      "openid","email","profile",
      "https://www.googleapis.com/auth/gmail.readonly",
      "https://www.googleapis.com/auth/gmail.send",
      "https://www.googleapis.com/auth/calendar"
    ].join(" ");

    // === Allowlist des destinations (?r=) ===
    const ALLOWLIST = [
      "https://mistergob.github.io/sphaira/",
      "https://mistergob.github.io/Oris/",
      "https://mistergob.github.io/Nexus/"
    ];
    function safeTarget(url){
      try{
        const u = new URL(url, location.origin);
        return ALLOWLIST.some(p => u.href.startsWith(p)) ? u.href : null;
      }catch{ return null; }
    }

    // === Supabase client ===
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        storage: window.localStorage,   // <-- partage de session entre modules (même origin)
        storageKey: STORAGE_KEY
      }
    });

    // === UI refs ===
    const loginGoogleBtn = document.getElementById('loginGoogle');
    const loginMsBtn     = document.getElementById('loginMicrosoft');
    const logoutBtn      = document.getElementById('logout');
    const whoSpan        = document.getElementById('who');
    const panel          = document.querySelector('.panel');
    const busyOverlay    = document.getElementById('busy');

    function setAuthBusy(busy){
      [loginGoogleBtn, loginMsBtn, logoutBtn].forEach(b=> b.disabled = !!busy);
      panel?.setAttribute('aria-busy', busy ? 'true' : 'false');
      busyOverlay?.setAttribute('data-show', busy ? '1' : '0');
    }

    function displayName(u){
      const meta = u?.user_metadata || {};
      return meta.full_name || meta.name || (u?.email?.split('@')[0]) || 'Connecté';
    }

    function show(session){
      const user = session?.user || null;
      if(user){
        whoSpan.textContent = `Connecté : ${displayName(user)}`;
        loginGoogleBtn.style.display = 'none';
        loginMsBtn.style.display     = 'none';
        logoutBtn.style.display      = '';
      }else{
        whoSpan.textContent = 'Non connecté';
        loginGoogleBtn.style.display = '';
        loginMsBtn.style.display     = '';
        logoutBtn.style.display      = 'none';
      }
    }

    // === Gestion ?r= (redirige UNIQUEMENT si un module l’a demandé) ===
    const SITE_URL = location.origin + location.pathname;
    const RT_STORE = window.sessionStorage;   // sessionStorage pour éviter les redirections “collantes”
    const RETURN_KEY = 'atmos:returnUrl';

    // Si on arrive “à froid” sans ?r= ni params OAuth → on nettoie tout résidu
    (function clearStaleReturnIfColdVisit(){
      const q = new URLSearchParams(location.search);
      const hasOAuth = q.has('code') || q.has('state') || q.has('error') || q.has('error_description');
      if(!q.has('r') && !hasOAuth){
        try{ RT_STORE.removeItem(RETURN_KEY); }catch{}
      }
    })();

    // Capture ?r= si présent (cas: module qui envoie vers ATMOS pour login)
    (function storeReturnUrlFromQuery(){
      const q = new URLSearchParams(location.search);
      const r = q.get('r');
      if(r){
        try{ RT_STORE.setItem(RETURN_KEY, decodeURIComponent(r)); }catch{}
      }
    })();

    function cleanOAuthParams(){
      const q = new URLSearchParams(location.search);
      if(q.has('code') || q.has('state') || q.has('error') || q.has('error_description')){
        history.replaceState({}, document.title, SITE_URL);
      }
    }

    async function maybeRedirectToReturn(session){
      if(!session) return;
      const raw = RT_STORE.getItem(RETURN_KEY);
      if(raw){
        RT_STORE.removeItem(RETURN_KEY);
        const target = safeTarget(raw);
        if(target) location.href = target;
      }
    }

    // === Login helpers ===
    async function signIn(provider, scopes, queryParams){
      try{
        setAuthBusy(true);
        const { error } = await supabase.auth.signInWithOAuth({
          provider,
          options: {
            redirectTo: SITE_URL,                       // revient sur ATMOS
            scopes: scopes || 'openid email profile',
            queryParams: queryParams || {}
          }
        });
        if(error){
          alert('Connexion impossible : ' + error.message);
          setAuthBusy(false);
        }
      }catch(err){
        alert('Erreur inattendue : ' + (err?.message || err));
        setAuthBusy(false);
      }
    }

    // Boutons : on demande tout (Gmail + Agenda) au moment du clic, sans prompt forcé
    loginGoogleBtn.onclick = () => signIn('google', FULL_GOOGLE_SCOPES, {
      include_granted_scopes: 'true',
      access_type: 'offline'
      // pas de prompt: 'consent' -> Google ne reprompt que si nécessaire
    });

    loginMsBtn.onclick = () => signIn('azure', 'openid email profile');

    logoutBtn.onclick = async ()=>{
      setAuthBusy(true);
      await supabase.auth.signOut();
      show(null);
      setAuthBusy(false);
    };

    // État initial + abonnement (aucune redirection si pas de RETURN_KEY)
    supabase.auth.getSession().then(({ data }) => {
      show(data.session);
      cleanOAuthParams();
      maybeRedirectToReturn(data.session); // ne fait rien si RETURN_KEY absent
    });

    supabase.auth.onAuthStateChange((_event, session) => {
      show(session);
      setAuthBusy(false);
      cleanOAuthParams();
      maybeRedirectToReturn(session);
    });

    if(location.protocol === 'file:'){
      whoSpan.textContent = 'Ouvre via HTTPS (GitHub Pages, Netlify…) pour que la connexion fonctionne.';
    }
  </script>
</body>
</html>
