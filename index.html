<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Espace de Travail ‚Äî sch√©ma</title>
<style>
  :root{
    --bg:#f5f6f8; --card:#fff; --text:#111827; --muted:#6b7280; --primary:#cc0000; --ring:rgba(17,24,39,0.08);
    --sidebar-w:260px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";background:var(--bg);color:var(--text);user-select:none;overflow:hidden}

  /* Zone sch√©ma (overlay ‚Äì Menu 2 ne d√©cale pas la vue) */
  .stage{position:relative;width:calc(100vw - var(--sidebar-w));height:100vh;margin-left:var(--sidebar-w);display:grid;place-items:center}
  .stage.panning, .stage.panning *{cursor:grabbing !important}

  /* Monde infini pannable */
  #world{position:absolute;inset:0;transform-origin:0 0;will-change:transform}
  /* Large SVG non-clipp√© pour lignes qui sortent du viewport */
  #wires{position:absolute;left:0;top:0;width:100%;height:100%;overflow:visible}

  /* Lignes */
  #wires line{pointer-events:stroke; cursor:pointer; transition:stroke .12s ease, stroke-width .12s ease}
  #wires line:hover{stroke:#ef4444; stroke-width:3}

  /* Cercles */
  .node{position:absolute;width:110px;height:110px;border-radius:9999px;background:var(--primary);color:#fff;
        display:flex;align-items:center;justify-content:center;font-weight:700;text-align:center;padding:10px;
        box-shadow:0 8px 24px var(--ring);cursor:grab;transition:transform .12s ease,box-shadow .12s ease,filter .12s ease}
  .node:active{cursor:grabbing}
  .node:hover{filter:brightness(1.05)}
  .node.selected{outline:3px solid #2563eb;box-shadow:0 0 0 6px rgba(37,99,235,.25),0 8px 24px var(--ring)}
  .node .label{
    pointer-events:none;line-height:1.1;width:100%;max-width:100%;overflow:hidden;word-break:break-word;hyphens:auto;
    /* contour du texte pour lisibilit√© */
    text-shadow:-1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
  }
  /* Badges */
  .url-badge{
    position:absolute; right:-6px; bottom:-6px; width:22px; height:22px; border-radius:9999px;
    border:1px solid #e5e7eb; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,.08);
    display:flex; align-items:center; justify-content:center; font-size:12px; color:#111827; text-decoration:none;
  }
  .url-badge:hover{background:#f3f4f6}
  .task-badge{
    position:absolute; right:-6px; top:-6px; width:22px; height:22px; border-radius:9999px;
    border:1px solid #e5e7eb; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,.08);
    display:flex; align-items:center; justify-content:center; font-size:12px; color:#f59e0b;
    user-select:none;
  }

  /* Menus contextuels (3 g√©n√©rique / 4 c≈ìur) */
  .menu{position:fixed;display:none;flex-direction:column;min-width:280px;background:var(--card);border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 20px 40px rgba(0,0,0,.15);overflow:hidden;z-index:80}
  .menu-body{display:flex;flex-direction:column}
  .menu button{appearance:none;background:transparent;border:0;text-align:left;padding:12px 14px;font-size:14px;cursor:pointer}
  .menu button:hover{background:#f3f4f6}
  .menu .row{display:flex;align-items:center;gap:10px;padding:10px 12px;border-top:1px solid #e5e7eb}
  .menu .row label{font-size:12px;color:var(--muted)}
  .menu .row input[type="color"]{width:36px;height:28px;border:1px solid #e5e7eb;border-radius:6px;padding:0;background:transparent;cursor:pointer}
  .menu select,.menu input[type="number"],.menu input[type="text"]{height:28px;border:1px solid #e5e7eb;border-radius:6px;padding:0 8px;background:transparent}
  .menu .toggle-group{display:flex;gap:8px}
  .menu .toggle{padding:6px 10px;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer}
  .menu .toggle[aria-pressed="true"]{background:#111827;color:#fff}
  .menu-spacer{flex:1 1 auto}
  .menu-footer{display:flex;gap:8px;justify-content:flex-end;padding:8px 10px;border-top:1px solid #e5e7eb;background:#fafafa}
  .icon-btn{width:36px;height:36px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.04);display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer}
  .icon-btn:hover{background:#f3f4f6}
  .icon-btn.small{width:28px;height:28px;font-size:14px;border-radius:8px}
  .icon-btn.star{color:#f59e0b}

  /* Toolbar */
  .toolbar{position:fixed;right:16px;top:16px;display:flex;gap:8px;background:var(--card);border:1px solid #e5e7eb;border-radius:14px;padding:8px;box-shadow:0 8px 24px var(--ring);z-index:75}
  .toolbar button{padding:8px 12px;border:0;border-radius:10px;background:#111827;color:#fff;font-weight:600;cursor:pointer}
  .toolbar button.secondary{background:#4b5563}
  .toolbar button.danger{background:#b91c1c}
  .toolbar button.active{outline:2px solid #2563eb}

  /* Menus 1 & 2 */
  .sidebar{position:fixed;left:0;top:0;bottom:0;width:var(--sidebar-w);background:var(--card);border-right:1px solid #e5e7eb;box-shadow:0 8px 24px var(--ring);padding:12px;overflow:auto;z-index:90}
  .sidebar2{position:fixed;left:var(--sidebar-w);top:0;bottom:0;width:260px;background:var(--card);border-right:1px solid #e5e7eb;box-shadow:0 8px 24px var(--ring);padding:12px;overflow:auto;z-index:90;display:none}
  .side-item{width:100%;text-align:left;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#111827;color:#fff;font-weight:700;cursor:pointer;margin-bottom:8px;transition:filter .12s ease}
  .side-item:hover{filter:brightness(1.05)}
  .child-list{list-style:none;padding-left:10px;margin:6px 0 12px}
  .child-list li{padding:6px 8px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;margin-bottom:6px;font-size:13px;cursor:pointer}
  .child-list li:hover{background:#f3f4f6}
  #closeMenu2{position:sticky; top:0; float:right; width:26px; height:26px; border-radius:8px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; font-weight:700; margin-left:auto}

  /* Boutons bas-droite */
  .home-btn{position:fixed;bottom:16px;width:44px;height:44px;border-radius:9999px;border:1px solid #e5e7eb;background:#fff;box-shadow:0 8px 24px var(--ring);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px;z-index:75}
  #homeBtn{right:16px}
  #tasksBtn{right:70px;color:#f59e0b}

  /* Modales */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:95}
  .modal .card{width:min(700px,calc(100vw - 32px));max-height:80vh;overflow:auto;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 20px 40px rgba(0,0,0,.25);padding:14px}
  .modal .card h3{margin:4px 0 10px 0}
  .modal .row{display:flex;gap:10px;margin:8px 0}
  .modal label{font-size:12px;color:var(--muted);min-width:72px}
  .modal input,.modal textarea{flex:1;border:1px solid #e5e7eb;border-radius:8px;padding:8px 10px;font:inherit;background:transparent}
  .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#111827;color:#fff;cursor:pointer}
  .btn.secondary{background:#4b5563}
  .list{display:flex;flex-direction:column;gap:8px;margin-top:6px}
  .task-item{border:1px solid #e5e7eb;border-radius:10px;padding:10px;background:#fafafa}
  .task-item small{color:#6b7280}
  .task-item .task-line{display:flex;align-items:center;gap:8px}
  .task-actions{display:flex;gap:6px;margin-left:auto}
  .task-actions .icon-btn.small{min-width:28px}

  @keyframes pulseNode{0%{box-shadow:0 0 0 0 rgba(17,24,39,.35)}100%{box-shadow:0 0 0 6px rgba(17,24,39,0)}}
  .node.pulse{animation:pulseNode 600ms ease-out 2}
</style>
</head>
<body>
  <!-- Menu 1 -->
  <aside id="sidebar" class="sidebar" aria-label="Navigation">
    <div id="principalList"></div>
  </aside>

  <!-- Menu 2 (overlay, uniquement apr√®s s√©lection via Menu 1, reste ouvert jusqu‚Äô√† la croix) -->
  <aside id="actions" class="sidebar sidebar2" aria-label="Actions du cercle">
    <button id="closeMenu2" title="Fermer">√ó</button>
    <div id="selectedInfo" style="font-size:12px;color:var(--muted);margin:0 0 8px;">Aucun cercle s√©lectionn√©</div>
    <div class="row" aria-label="Titre (panneau)">
      <label for="titleInput2">Titre</label>
      <input id="titleInput2" type="text" placeholder="Nom du cercle" style="flex:1" />
    </div>
    <button id="actAddPrincipal" class="side-item" type="button">‚ûï Cercle principal</button>
    <button id="actAddSecondary" class="side-item" type="button">‚ûï Cercle secondaire</button>
    <button id="actAddTask" class="side-item" type="button" title="Ajouter une t√¢che">‚≠ê Ajouter une t√¢che</button>
    <button id="actWire" class="side-item" type="button">üîó Connecter √†‚Ä¶</button>
    <div class="row" aria-label="Couleur (panneau)">
      <label for="colorPicker2">Couleur</label>
      <input id="colorPicker2" type="color" value="#CC0000" />
    </div>
    <div class="row" aria-label="Police (panneau)">
      <label for="fontSelect2">Police</label>
      <select id="fontSelect2">
        <option value="system-ui">Syst√®me</option>
        <option value="Arial">Arial</option>
        <option value="Roboto">Roboto</option>
        <option value="Georgia">Georgia</option>
        <option value="'Times New Roman'">Times New Roman</option>
        <option value="'Courier New'">Courier New</option>
      </select>
    </div>
    <div class="row" aria-label="Taille max (panneau)">
      <label for="fontSizeMax2">Taille max</label>
      <input id="fontSizeMax2" type="number" min="6" max="72" step="1" value="32" />
    </div>
    <div class="row" aria-label="Style (panneau)">
      <label>Style</label>
      <div class="toggle-group">
        <button type="button" id="boldBtn2" class="toggle" aria-pressed="true">Gras</button>
        <button type="button" id="italicBtn2" class="toggle" aria-pressed="false">Italique</button>
        <button type="button" id="underlineBtn2" class="toggle" aria-pressed="false">Soulign√©</button>
      </div>
    </div>
    <button id="actCenter" class="side-item" type="button">üéØ Centrer sur le cercle</button>
    <button id="actDelete" class="side-item" type="button" style="background:#b91c1c">üóëÔ∏è Supprimer le cercle</button>
  </aside>

  <!-- Zone sch√©ma -->
  <div id="stage" class="stage" aria-label="Espace de travail">
    <div id="world">
      <svg id="wires" aria-hidden="true"></svg>
      <div id="main-node" class="node" data-id="node-0" style="left: 0px; top: 0px;">
        <span class="label">Cercle principal</span>
      </div>
    </div>
  </div>

  <!-- Menu 3 (clic droit cercle) -->
  <div id="menu" class="menu" role="menu" aria-hidden="true">
    <div class="menu-body">
      <div class="row" aria-label="Titre (menu 3)">
        <label for="titleInput3">Titre</label>
        <input id="titleInput3" type="text" placeholder="Nom du cercle" style="flex:1" />
      </div>
      <button data-action="add">‚ûï Cercle principal</button>
      <button data-action="addSmall">‚ûï Cercle secondaire</button>
      <div class="row" aria-label="URL">
        <button data-action="setUrl" style="flex:1">üîó Lier une URL‚Ä¶</button>
        <a id="openUrlBtnMenu" class="icon-btn small" title="Ouvrir l‚ÄôURL" target="_blank" rel="noopener noreferrer">‚Üó</a>
      </div>
      <div class="row" aria-label="Couleur">
        <label for="colorPicker">Couleur</label>
        <input id="colorPicker" type="color" value="#CC0000" />
      </div>
      <div class="row" aria-label="Police">
        <label for="fontSelect">Police</label>
        <select id="fontSelect">
          <option value="system-ui">Syst√®me</option>
          <option value="Arial">Arial</option>
          <option value="Roboto">Roboto</option>
          <option value="Georgia">Georgia</option>
          <option value="'Times New Roman'">Times New Roman</option>
          <option value="'Courier New'">Courier New</option>
        </select>
      </div>
      <div class="row" aria-label="Taille max">
        <label for="fontSizeMax">Taille max</label>
        <input id="fontSizeMax" type="number" min="6" max="72" step="1" value="32" />
      </div>
      <div class="row" aria-label="Style">
        <label>Style</label>
        <div class="toggle-group">
          <button type="button" id="boldBtn" class="toggle" aria-pressed="true">Gras</button>
          <button type="button" id="italicBtn" class="toggle" aria-pressed="false">Italique</button>
          <button type="button" id="underlineBtn" class="toggle" aria-pressed="false">Soulign√©</button>
        </div>
      </div>
      <div class="menu-spacer"></div>
      <div class="menu-footer">
        <button id="iconTaskBtn" class="icon-btn star" title="Ajouter une t√¢che" aria-label="Ajouter une t√¢che">‚≠ê</button>
        <button id="iconWireBtn" class="icon-btn" title="Connecter √†‚Ä¶" aria-label="Connecter √†‚Ä¶">üîó</button>
        <button id="iconCenterBtn" class="icon-btn" title="Centrer sur le cercle" aria-label="Centrer sur le cercle">üéØ</button>
        <button id="iconDeleteBtn" class="icon-btn" title="Supprimer le cercle" aria-label="Supprimer le cercle">üóëÔ∏è</button>
      </div>
    </div>
  </div>

  <!-- Menu 4 (c≈ìur ‚Äì m√™me apparence que menu 3 pour l‚Äôinstant) -->
  <div id="menuHeart" class="menu" role="menu" aria-hidden="true">
    <div class="menu-body">
      <div class="row"><label for="colorPickerH">Couleur</label><input id="colorPickerH" type="color" value="#CC0000"/></div>
      <div class="row"><label for="fontSelectH">Police</label>
        <select id="fontSelectH">
          <option value="system-ui">Syst√®me</option><option value="Arial">Arial</option><option value="Roboto">Roboto</option>
          <option value="Georgia">Georgia</option><option value="'Times New Roman'">Times New Roman</option><option value="'Courier New'">Courier New</option>
        </select>
      </div>
      <div class="row"><label for="fontSizeMaxH">Taille max</label><input id="fontSizeMaxH" type="number" min="6" max="72" step="1" value="32"/></div>
      <div class="row">
        <label>Style</label>
        <div class="toggle-group">
          <button type="button" id="boldBtnH" class="toggle" aria-pressed="true">Gras</button>
          <button type="button" id="italicBtnH" class="toggle" aria-pressed="false">Italique</button>
          <button type="button" id="underlineBtnH" class="toggle" aria-pressed="false">Soulign√©</button>
        </div>
      </div>
      <button data-action="add">‚ûï Cercle principal</button>
      <button data-action="addSmall">‚ûï Cercle secondaire</button>
      <button data-action="wire">üîó Connecter √†‚Ä¶</button>
      <div class="menu-spacer"></div>
      <div class="menu-footer">
        <button id="iconCenterBtnH" class="icon-btn" title="Centrer sur le c≈ìur" aria-label="Centrer sur le c≈ìur">üéØ</button>
        <button id="iconDeleteBtnH" class="icon-btn" title="(d√©sactiv√©)" aria-label="Supprimer" disabled>üóëÔ∏è</button>
      </div>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar" aria-label="Actions rapides">
    <button id="wireModeBtn" class="secondary">C√¢bler (C)</button>
    <button id="exportBtn">Exporter JSON</button>
    <button id="importBtn" class="secondary">Importer JSON</button>
    <button id="resetBtn" class="danger">R√©initialiser</button>
    <input id="fileInput" type="file" accept="application/json" style="display:none"/>
  </div>

  <!-- Boutons bas-droite -->
  <button id="tasksBtn" class="home-btn" title="Voir toutes les t√¢ches">‚≠ê</button>
  <button id="homeBtn" class="home-btn" title="Recentrer sur le c≈ìur">‚ô•</button>

  <!-- Modal √©diteur de t√¢ches (par cercle) -->
  <div id="taskEditor" class="modal" aria-hidden="true">
    <div class="card">
      <h3 id="taskEditorTitle">T√¢ches du cercle</h3>
      <div id="nodeTasksList" class="list" style="margin-bottom:10px"></div>
      <div class="row"><label>Titre</label><input id="taskTitle" type="text" placeholder="Titre de la t√¢che"/></div>
      <div class="row"><label>Note</label><textarea id="taskDesc" rows="4" placeholder="Description ou notes"></textarea></div>
      <div class="actions">
        <button id="taskCancel" class="btn secondary">Fermer</button>
        <button id="taskSave" class="btn">Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- Modal liste globale des t√¢ches -->
  <div id="tasksModal" class="modal" aria-hidden="true">
    <div class="card">
      <h3>Liste des t√¢ches</h3>
      <div id="tasksContainer" class="list"></div>
      <div class="actions">
        <button id="tasksClose" class="btn">Fermer</button>
      </div>
    </div>
  </div>

<script>
/* ========== R√©f√©rences DOM ========== */
const stage = document.getElementById('stage');
const world = document.getElementById('world');
const svg = document.getElementById('wires');

const menu = document.getElementById('menu');           // Menu 3
const menuHeart = document.getElementById('menuHeart'); // Menu 4 (coeur)
const mainNode = document.getElementById('main-node');

const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const resetBtn = document.getElementById('resetBtn');
const fileInput = document.getElementById('fileInput');
const homeBtn = document.getElementById('homeBtn');
const wireModeBtn = document.getElementById('wireModeBtn');
const tasksBtn = document.getElementById('tasksBtn');

/* Menu 3 */
const titleInput3 = document.getElementById('titleInput3');
const colorPicker = document.getElementById('colorPicker');
const fontSelect = document.getElementById('fontSelect');
const fontSizeMax = document.getElementById('fontSizeMax');
const boldBtn = document.getElementById('boldBtn');
const italicBtn = document.getElementById('italicBtn');
const underlineBtn = document.getElementById('underlineBtn');
const iconWireBtn = document.getElementById('iconWireBtn');
const iconCenterBtn = document.getElementById('iconCenterBtn');
const iconDeleteBtn = document.getElementById('iconDeleteBtn');
const iconTaskBtn = document.getElementById('iconTaskBtn');
const openUrlBtnMenu = document.getElementById('openUrlBtnMenu');

/* Menu 4 (coeur) */
const colorPickerH = document.getElementById('colorPickerH');
const fontSelectH = document.getElementById('fontSelectH');
const fontSizeMaxH = document.getElementById('fontSizeMaxH');
const boldBtnH = document.getElementById('boldBtnH');
const italicBtnH = document.getElementById('italicBtnH');
const underlineBtnH = document.getElementById('underlineBtnH');
const iconCenterBtnH = document.getElementById('iconCenterBtnH');

/* Menus 1/2 */
const principalList = document.getElementById('principalList');
const actionsPanel = document.getElementById('actions');
const selectedInfo = document.getElementById('selectedInfo');
const closeMenu2Btn = document.getElementById('closeMenu2');
const titleInput2 = document.getElementById('titleInput2');
const actAddPrincipal = document.getElementById('actAddPrincipal');
const actAddSecondary = document.getElementById('actAddSecondary');
const actAddTask = document.getElementById('actAddTask');
const actWire = document.getElementById('actWire');
const actCenter = document.getElementById('actCenter');
const actDelete = document.getElementById('actDelete');
const colorPicker2 = document.getElementById('colorPicker2');
const fontSelect2 = document.getElementById('fontSelect2');
const fontSizeMax2 = document.getElementById('fontSizeMax2');
const boldBtn2 = document.getElementById('boldBtn2');
const italicBtn2 = document.getElementById('italicBtn2');
const underlineBtn2 = document.getElementById('underlineBtn2');

/* Modales t√¢ches */
const taskEditor = document.getElementById('taskEditor');
const taskEditorTitle = document.getElementById('taskEditorTitle');
const nodeTasksList = document.getElementById('nodeTasksList');
const taskTitle = document.getElementById('taskTitle');
const taskDesc = document.getElementById('taskDesc');
const taskSave = document.getElementById('taskSave');
const taskCancel = document.getElementById('taskCancel');

const tasksModal = document.getElementById('tasksModal');
const tasksContainer = document.getElementById('tasksContainer');
const tasksClose = document.getElementById('tasksClose');

/* ========== Etat ========== */
let currentNode = null;
let idCounter = 1;
const BIG_SIZE = 110, SMALL_SIZE = 55;

const camera = { x: 0, y: 0, z: 1 }; // z r√©serv√© si zoom plus tard
function applyCamera(){ world.style.transform = `translate(${camera.x}px, ${camera.y}px) scale(${camera.z})`; }
function stageRect(){ return stage.getBoundingClientRect(); }
function pointerToWorld(e){ const r=stageRect(); return { wx:(e.clientX - r.left - camera.x)/camera.z, wy:(e.clientY - r.top - camera.y)/camera.z }; }

/* Connexions */
const qLines = ()=> svg.querySelectorAll('line');
function centerInWorld(el){ return { x: el.offsetLeft + el.offsetWidth/2, y: el.offsetTop + el.offsetHeight/2 }; }
function updateLineEnds(line){
  const a = world.querySelector(`[data-id="${line.dataset.from}"]`);
  const b = world.querySelector(`[data-id="${line.dataset.to}"]`);
  if(!a || !b) return;
  const c1=centerInWorld(a), c2=centerInWorld(b);
  line.setAttribute('x1',c1.x); line.setAttribute('y1',c1.y);
  line.setAttribute('x2',c2.x); line.setAttribute('y2',c2.y);
}
function updateLinesFor(node){
  const id=node.dataset.id;
  qLines().forEach(l=>{ if(l.dataset.from===id||l.dataset.to===id) updateLineEnds(l); });
}
function updateAllLines(){ qLines().forEach(updateLineEnds); }
function isPrincipalNode(n){ return Math.abs(n.offsetWidth - BIG_SIZE) < 0.5; }
function isSecondaryNode(n){ return Math.abs(n.offsetWidth - SMALL_SIZE) < 0.5; }
function styleLineByNodes(line){
  const a = world.querySelector(`[data-id="${line.dataset.from}"]`);
  const b = world.querySelector(`[data-id="${line.dataset.to}"]`);
  if(a && b && isSecondaryNode(a) && isSecondaryNode(b)){
    line.setAttribute('stroke','#d1d5db'); line.setAttribute('stroke-dasharray','6 6');
  }else{
    line.setAttribute('stroke','#111827'); line.removeAttribute('stroke-dasharray');
  }
}
function attachLineEvents(line){
  line.addEventListener('click', (e)=>{
    e.stopPropagation();
    if(confirm('Supprimer cette connexion ?')){ line.remove(); saveState(); refreshSidebar(); }
  });
}
function findLine(aId,bId){
  for(const l of qLines()){ if((l.dataset.from===aId&&l.dataset.to===bId)||(l.dataset.from===bId&&l.dataset.to===aId)) return l; }
  return null;
}
function createLine(a,b){
  if(findLine(a.dataset.id,b.dataset.id)) return null;
  const line=document.createElementNS('http://www.w3.org/2000/svg','line');
  line.setAttribute('stroke','#111827'); line.setAttribute('stroke-width','2'); line.setAttribute('stroke-linecap','round');
  line.dataset.from=a.dataset.id; line.dataset.to=b.dataset.id;
  svg.appendChild(line); styleLineByNodes(line); updateLineEnds(line); attachLineEvents(line); return line;
}
function neighborsOf(id){
  const res=[]; qLines().forEach(l=>{ if(l.dataset.from===id) res.push(l.dataset.to); else if(l.dataset.to===id) res.push(l.dataset.from); });
  return [...new Set(res)];
}

/* Menu 2 : affichage contr√¥l√© */
let menu2Locked = false; // vrai uniquement apr√®s s√©lection via Menu 1
function openMenu2For(node){
  menu2Locked = true;
  setCurrentNode(node);
  actionsPanel.style.display = 'block';
  syncActionPanel();
}
function closeMenu2(){
  menu2Locked = false;
  actionsPanel.style.display = 'none';
}

/* Fitting texte */
function fitLabelToNode(node){
  const label=node.querySelector('.label'); if(!label) return;
  label.style.width='100%'; label.style.maxWidth='100%'; label.style.whiteSpace='normal'; label.style.overflow='hidden'; label.style.wordBreak='break-word';
  const cs=getComputedStyle(node);
  const padX=(parseFloat(cs.paddingLeft)||0)+(parseFloat(cs.paddingRight)||0);
  const padY=(parseFloat(cs.paddingTop)||0)+(parseFloat(cs.paddingBottom)||0);
  const contentW=Math.max(0,node.clientWidth-padX);
  const contentH=Math.max(0,node.clientHeight-padY);
  const cap=parseFloat(node.dataset.maxFont);
  let low=6, high=Math.max(6, Math.floor(Math.min(contentH, Number.isFinite(cap)?cap:contentH))), best=low;
  const txt=(label.textContent||'').trim();
  if(!txt){ label.style.fontSize=Math.min(16,high)+'px'; return; }
  for(let i=0;i<12 && low<=high;i++){
    const mid=(low+high)>>1; label.style.fontSize=mid+'px';
    const fits=label.scrollWidth<=contentW && label.scrollHeight<=contentH;
    if(fits){ best=mid; low=mid+1; } else { high=mid-1; }
  }
  label.style.fontSize=best+'px';
}
function fitAllLabels(){ world.querySelectorAll('.node').forEach(fitLabelToNode); }

/* S√©lection */
function setCurrentNode(node){
  world.querySelectorAll('.node.selected').forEach(n=>n.classList.remove('selected'));
  currentNode = node || null;
  if(currentNode) currentNode.classList.add('selected');
  syncActionPanel();
}
function enableActionPanel(enabled){
  const ctrls=actionsPanel.querySelectorAll('button,select,input');
  ctrls.forEach(el=>{ if(el.id!=='closeMenu2') el.disabled = !enabled; });
  selectedInfo.textContent = enabled && currentNode ? (currentNode.querySelector('.label')?.textContent || currentNode.dataset.id) : 'Aucun cercle s√©lectionn√©';
}
function syncActionPanel(){
  if(!menu2Locked || !currentNode){ enableActionPanel(false); return; }
  enableActionPanel(true);
  const labelEl=currentNode.querySelector('.label');
  titleInput2.value = labelEl.textContent || '';
  const hex=toHex(getComputedStyle(currentNode).backgroundColor)||'#CC0000';
  colorPicker2.value = hex;
  const fam = labelEl.style.fontFamily || 'system-ui';
  fontSelect2.value = fam;
  fontSizeMax2.value = currentNode.dataset.maxFont || '32';
  const cs=getComputedStyle(labelEl);
  const fw=parseInt(cs.fontWeight,10); const isBold=(fw>=600)||cs.fontWeight==='bold';
  const isItalic=cs.fontStyle==='italic';
  const isUnderline=(cs.textDecorationLine||cs.textDecoration||'').includes('underline');
  boldBtn2.setAttribute('aria-pressed', isBold?'true':'false');
  italicBtn2.setAttribute('aria-pressed', isItalic?'true':'false');
  underlineBtn2.setAttribute('aria-pressed', isUnderline?'true':'false');
}

/* Couleurs */
function normalizeHex(input){
  if(!input) return null;
  let m=String(input).match(/^#?([0-9a-fA-F]{6})$/); if(m) return '#'+m[1].toUpperCase();
  m=String(input).match(/^#?([0-9a-fA-F]{3})$/); if(m) return '#'+m[1].split('').map(c=>c+c).join('').toUpperCase();
  return null;
}
function toHex(input){
  if(!input) return null;
  const hx=String(input).trim().match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);
  if(hx){ const h=hx[1]; return '#'+(h.length===3?h.split('').map(c=>c+c).join(''):h).toUpperCase(); }
  const m=String(input).match(/rgba?\(\s*([0-9.]+)[,\s]+([0-9.]+)[,\s]+([0-9.]+)/i);
  if(!m) return null;
  const [r,g,b]=[m[1],m[2],m[3]].map(v=>Math.max(0,Math.min(255,Math.round(parseFloat(v)))));
  return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('').toUpperCase();
}

/* Cr√©ation de n≈ìuds */
let idCounterInitDone=false;
function nextId(){ if(!idCounterInitDone){ idCounterInitDone=true; } return `node-${idCounter++}`; }
function addBadges(node){
  // URL
  const url = node.dataset.url;
  let a=node.querySelector('.url-badge');
  if(url){ if(!a){ a=document.createElement('a'); a.className='url-badge'; a.target='_blank'; a.rel='noopener noreferrer'; a.title='Ouvrir le lien'; a.textContent='‚Üó'; node.appendChild(a); } a.href=url; }
  else if(a){ a.remove(); }
  // T√¢ches
  const hasTasks = tasks.some(t=>t.nodeId===node.dataset.id);
  let t=node.querySelector('.task-badge');
  if(hasTasks){ if(!t){ t=document.createElement('div'); t.className='task-badge'; t.title='T√¢ches'; t.textContent='‚≠ê'; node.appendChild(t); } }
  else if(t){ t.remove(); }
}
function createNode({x,y,w,h,text,color}){
  const n=document.createElement('div');
  n.className='node';
  n.dataset.id = nextId();
  n.style.left = `${x}px`; n.style.top = `${y}px`;
  n.style.width = `${w}px`; n.style.height = `${h}px`;
  n.style.backgroundColor = color || '#CC0000';
  n.innerHTML = `<span class="label"></span>`;
  n.querySelector('.label').textContent = text || (w===BIG_SIZE?'Cercle principal':'Cercle secondaire');
  world.appendChild(n);
  enableNode(n);
  fitLabelToNode(n);
  addBadges(n);
  return n;
}
function addNodeNear(target, size){ // size: BIG_SIZE or SMALL_SIZE
  const x = target.offsetLeft + target.offsetWidth + 30;
  const y = target.offsetTop + target.offsetHeight + 30;
  return createNode({x,y,w:size,h:size,color:toHex(getComputedStyle(target).backgroundColor),text:size===BIG_SIZE?'Cercle principal':'Cercle secondaire'});
}

/* Drag & pan */
function enableNode(node){
  if(node._enabled) return;
  node._enabled=true;

  // Drag (gauche) ‚Äì en coordonn√©es monde (sans clamp)
  node.addEventListener('pointerdown', (e)=>{
    if(e.button!==0) return; // seulement clic gauche pour drag
    // Si c√¢blage actif, la s√©lection se fait ailleurs
    if(wiring.active){ return; }
    setCurrentNode(node);
    const start = pointerToWorld(e);
    const n0x = node.offsetLeft, n0y = node.offsetTop;

    // Followers : si principal ‚Üí seconds connect√©s suivent
    let followers = [];
    if(isPrincipalNode(node)){
      const neigh = neighborsOf(node.dataset.id).map(id=>world.querySelector(`[data-id="${id}"]`)).filter(Boolean);
      followers = neigh.filter(isSecondaryNode);
    }
    const f0 = followers.map(f=>({el:f, x:f.offsetLeft, y:f.offsetTop}));

    node.setPointerCapture(e.pointerId);
    const onMove = (ev)=>{
      const p=pointerToWorld(ev);
      const dx=p.wx - start.wx, dy=p.wy - start.wy;
      node.style.left = (n0x + dx) + 'px';
      node.style.top  = (n0y + dy) + 'px';
      updateLinesFor(node);
      // followers bougent du m√™me delta
      f0.forEach(o=>{ o.el.style.left = (o.x + dx) + 'px'; o.el.style.top = (o.y + dy) + 'px'; updateLinesFor(o.el); });
    };
    const onUp = ()=>{
      node.releasePointerCapture(e.pointerId);
      node.removeEventListener('pointermove', onMove);
      node.removeEventListener('pointerup', onUp);
      saveState();
    };
    node.addEventListener('pointermove', onMove);
    node.addEventListener('pointerup', onUp);
  });

  // Menu contextuel (clic droit uniquement)
  node.addEventListener('contextmenu', (e)=>{
    e.preventDefault();
    setCurrentNode(node);
    openContextMenu(node===mainNode?menuHeart:menu, e.clientX, e.clientY);
  });

  // C√¢blage par clic (quand wiring actif)
  node.addEventListener('click', (e)=>{
    if(!wiring.active) return;
    e.stopPropagation();
    if(!wiring.source){ wiring.source = node; flash(node); return; }
    if(wiring.source === node){ wiring.source = null; return; }
    createLine(wiring.source, node);
    styleLineByNodes(findLine(wiring.source.dataset.id, node.dataset.id));
    wiring.source = null;
    wiringStopGhost();
    saveState();
  });
}
function flash(n){ n.classList.add('pulse'); setTimeout(()=>n.classList.remove('pulse'),700); }

/* Panning √† la roulette (bouton 1) */
let panActive=false, panLast=null;
stage.addEventListener('pointerdown',(e)=>{
  if(e.button!==1) return; // bouton central
  panActive=true; panLast={x:e.clientX, y:e.clientY};
  stage.classList.add('panning');
  const onMove=(ev)=>{
    if(!panActive) return;
    const dx=ev.clientX - panLast.x, dy=ev.clientY - panLast.y;
    camera.x += dx; camera.y += dy; applyCamera();
    panLast={x:ev.clientX, y:ev.clientY};
  };
  const onUp=()=>{
    panActive=false; panLast=null; stage.classList.remove('panning');
    stage.removeEventListener('pointermove', onMove);
    stage.removeEventListener('pointerup', onUp);
  };
  stage.addEventListener('pointermove', onMove);
  stage.addEventListener('pointerup', onUp, {once:true});
});

/* Contexte menus */
function openContextMenu(which, cx, cy){
  // sync contr√¥les
  if(which===menu){
    const node=currentNode, label=node.querySelector('.label');
    titleInput3.value = label.textContent || '';
    colorPicker.value = toHex(getComputedStyle(node).backgroundColor) || '#CC0000';
    fontSelect.value = label.style.fontFamily || 'system-ui';
    fontSizeMax.value = node.dataset.maxFont || '32';
    const cs=getComputedStyle(label);
    boldBtn.setAttribute('aria-pressed', (parseInt(cs.fontWeight,10)>=600 || cs.fontWeight==='bold')?'true':'false');
    italicBtn.setAttribute('aria-pressed', cs.fontStyle==='italic'?'true':'false');
    underlineBtn.setAttribute('aria-pressed', (cs.textDecorationLine||cs.textDecoration||'').includes('underline')?'true':'false');
    const url=currentNode.dataset.url||'';
    if(url){ openUrlBtnMenu.href=url; openUrlBtnMenu.style.opacity='1'; openUrlBtnMenu.style.pointerEvents='auto'; }
    else { openUrlBtnMenu.removeAttribute('href'); openUrlBtnMenu.style.opacity='.4'; openUrlBtnMenu.style.pointerEvents='none'; }
  }
  const vw=window.innerWidth, vh=window.innerHeight;
  const r=which.getBoundingClientRect();
  const x=Math.min(cx, vw - r.width - 8), y=Math.min(cy, vh - r.height - 8);
  which.style.left = x+'px'; which.style.top=y+'px';
  which.style.display='flex'; which.setAttribute('aria-hidden','false');
}
function closeMenus(){ [menu,menuHeart].forEach(m=>{ m.style.display='none'; m.setAttribute('aria-hidden','true'); }); }
document.addEventListener('click',(e)=>{ if(!menu.contains(e.target) && !menuHeart.contains(e.target)) closeMenus(); });

/* Menu 3 actions */
menu.addEventListener('click', (e)=>{
  const btn=e.target.closest('button'); if(!btn||!currentNode) return;
  const action=btn.dataset.action;
  if(action==='add'){ const n=addNodeNear(currentNode, BIG_SIZE); createLine(currentNode,n); saveState(); closeMenus(); }
  else if(action==='addSmall'){ const n=addNodeNear(currentNode, SMALL_SIZE); createLine(currentNode,n); saveState(); closeMenus(); }
  else if(action==='setUrl'){
    const prev=currentNode.dataset.url||'';
    const url=prompt('Entrez une URL (https://...) :', prev);
    if(url!==null){
      const val=url.trim();
      if(val && !/^https?:\/\//i.test(val)){ alert('URL invalide (commencez par http(s)://)'); }
      else{
        if(val){ currentNode.dataset.url=val; } else { delete currentNode.dataset.url; }
        addBadges(currentNode);
        // maj bouton ‚Üó
        if(val){ openUrlBtnMenu.href=val; openUrlBtnMenu.style.opacity='1'; openUrlBtnMenu.style.pointerEvents='auto'; }
        else { openUrlBtnMenu.removeAttribute('href'); openUrlBtnMenu.style.opacity='.4'; openUrlBtnMenu.style.pointerEvents='none'; }
        saveState();
      }
    }
  }
});
/* Entr√©es directes Menu 3 (titre / style / couleur / ic√¥nes bas) */
titleInput3.addEventListener('input', ()=>{ if(!currentNode) return; currentNode.querySelector('.label').textContent = titleInput3.value; fitLabelToNode(currentNode); saveState(); refreshSidebar(); });
colorPicker.addEventListener('input',(e)=>{ if(!currentNode) return; const h=normalizeHex(e.target.value); if(!h) return; currentNode.style.backgroundColor=h; colorPicker2.value=h; saveState(); });
fontSelect.addEventListener('change',(e)=>{ if(!currentNode) return; currentNode.querySelector('.label').style.fontFamily=e.target.value; fitLabelToNode(currentNode); fontSelect2.value=e.target.value; saveState(); });
fontSizeMax.addEventListener('input',(e)=>{ if(!currentNode) return; const v=Math.max(6, Math.min(72, parseFloat(e.target.value)||32)); currentNode.dataset.maxFont=String(v); fontSizeMax2.value=String(v); fitLabelToNode(currentNode); saveState(); });
const toggle=(btn,other,apply)=>{ const newState = btn.getAttribute('aria-pressed')==='true'?'false':'true'; btn.setAttribute('aria-pressed',newState); if(other) other.setAttribute('aria-pressed',newState); apply(newState==='true'); fitLabelToNode(currentNode); saveState(); };
boldBtn.addEventListener('click',(e)=>{ e.stopPropagation(); if(!currentNode) return; toggle(boldBtn,null,(on)=> currentNode.querySelector('.label').style.fontWeight = on?'700':'400'); });
italicBtn.addEventListener('click',(e)=>{ e.stopPropagation(); if(!currentNode) return; toggle(italicBtn,null,(on)=> currentNode.querySelector('.label').style.fontStyle = on?'italic':'normal'); });
underlineBtn.addEventListener('click',(e)=>{ e.stopPropagation(); if(!currentNode) return; toggle(underlineBtn,null,(on)=> currentNode.querySelector('.label').style.textDecoration = on?'underline':'none'); });

iconWireBtn.addEventListener('click',()=>{ if(!currentNode) return; wiringStart(currentNode); });
iconCenterBtn.addEventListener('click',()=>{ if(!currentNode) return; centerViewOn(currentNode); });
iconDeleteBtn.addEventListener('click',()=>{ if(!currentNode) return; deleteNode(currentNode); });
iconTaskBtn.addEventListener('click',()=>{ if(!currentNode) return; openTaskEditor(currentNode); });

/* Menu 4 (coeur) */
menuHeart.addEventListener('click',(e)=>{
  const btn=e.target.closest('button'); if(!btn) return;
  const action=btn.dataset.action;
  if(action==='add'){ const n=addNodeNear(mainNode, BIG_SIZE); createLine(mainNode,n); saveState(); closeMenus(); }
  else if(action==='addSmall'){ const n=addNodeNear(mainNode, SMALL_SIZE); createLine(mainNode,n); saveState(); closeMenus(); }
  else if(action==='wire'){ wiringStart(mainNode); }
});
colorPickerH.addEventListener('input',(e)=>{ const h=normalizeHex(e.target.value); if(!h) return; mainNode.style.backgroundColor=h; saveState(); });
fontSelectH.addEventListener('change',(e)=>{ mainNode.querySelector('.label').style.fontFamily=e.target.value; fitLabelToNode(mainNode); saveState(); });
fontSizeMaxH.addEventListener('input',(e)=>{ const v=Math.max(6,Math.min(72,parseFloat(e.target.value)||32)); mainNode.dataset.maxFont=String(v); fitLabelToNode(mainNode); saveState(); });
boldBtnH.addEventListener('click',(e)=>{ e.stopPropagation(); const on=boldBtnH.getAttribute('aria-pressed')!=='true'; boldBtnH.setAttribute('aria-pressed',on?'true':'false'); mainNode.querySelector('.label').style.fontWeight=on?'700':'400'; fitLabelToNode(mainNode); saveState(); });
italicBtnH.addEventListener('click',(e)=>{ e.stopPropagation(); const on=italicBtnH.getAttribute('aria-pressed')!=='true'; italicBtnH.setAttribute('aria-pressed',on?'true':'false'); mainNode.querySelector('.label').style.fontStyle=on?'italic':'normal'; fitLabelToNode(mainNode); saveState(); });
underlineBtnH.addEventListener('click',(e)=>{ e.stopPropagation(); const on=underlineBtnH.getAttribute('aria-pressed')!=='true'; underlineBtnH.setAttribute('aria-pressed',on?'true':'false'); mainNode.querySelector('.label').style.textDecoration=on?'underline':'none'; fitLabelToNode(mainNode); saveState(); });
iconCenterBtnH.addEventListener('click',()=> centerViewOn(mainNode));

/* Menu 2 actions (reste ouvert jusqu‚Äô√† la croix) */
closeMenu2Btn.addEventListener('click', closeMenu2);
titleInput2.addEventListener('input', ()=>{ if(!currentNode) return; currentNode.querySelector('.label').textContent = titleInput2.value; fitLabelToNode(currentNode); saveState(); refreshSidebar(); });
colorPicker2.addEventListener('input',(e)=>{ if(!currentNode) return; const h=normalizeHex(e.target.value); if(!h) return; currentNode.style.backgroundColor=h; colorPicker.value=h; saveState(); });
fontSelect2.addEventListener('change',(e)=>{ if(!currentNode) return; currentNode.querySelector('.label').style.fontFamily=e.target.value; fitLabelToNode(currentNode); fontSelect.value=e.target.value; saveState(); });
fontSizeMax2.addEventListener('input',(e)=>{ if(!currentNode) return; const v=Math.max(6,Math.min(72,parseFloat(e.target.value)||32)); currentNode.dataset.maxFont=String(v); fontSizeMax.value=String(v); fitLabelToNode(currentNode); saveState(); });
boldBtn2.addEventListener('click',()=>{ if(!currentNode) return; const on=boldBtn2.getAttribute('aria-pressed')!=='true'; boldBtn2.setAttribute('aria-pressed',on?'true':'false'); currentNode.querySelector('.label').style.fontWeight=on?'700':'400'; fitLabelToNode(currentNode); saveState(); });
italicBtn2.addEventListener('click',()=>{ if(!currentNode) return; const on=italicBtn2.getAttribute('aria-pressed')!=='true'; italicBtn2.setAttribute('aria-pressed',on?'true':'false'); currentNode.querySelector('.label').style.fontStyle=on?'italic':'normal'; fitLabelToNode(currentNode); saveState(); });
underlineBtn2.addEventListener('click',()=>{ if(!currentNode) return; const on=underlineBtn2.getAttribute('aria-pressed')!=='true'; underlineBtn2.setAttribute('aria-pressed',on?'true':'false'); currentNode.querySelector('.label').style.textDecoration=on?'underline':'none'; fitLabelToNode(currentNode); saveState(); });
actAddPrincipal.addEventListener('click',()=>{ if(!currentNode) return; const n=addNodeNear(currentNode,BIG_SIZE); createLine(currentNode,n); saveState(); });
actAddSecondary.addEventListener('click',()=>{ if(!currentNode) return; const n=addNodeNear(currentNode,SMALL_SIZE); createLine(currentNode,n); saveState(); });
actWire.addEventListener('click',()=>{ if(!currentNode) return; wiringStart(currentNode); });
actCenter.addEventListener('click',()=>{ if(!currentNode) return; centerViewOn(currentNode); });
actDelete.addEventListener('click',()=>{ if(!currentNode) return; deleteNode(currentNode); });
actAddTask.addEventListener('click',()=>{ if(!currentNode) return; openTaskEditor(currentNode); });

/* Wiring (mode connexion) */
const wiring = { active:false, source:null, ghost:null };
function wiringStart(source){
  wiring.active = true; wiring.source = source || currentNode || null;
  wireModeBtn.classList.add('active');
  startGhost();
}
function wiringStop(){
  wiring.active=false; wiring.source=null;
  wireModeBtn.classList.remove('active');
  wiringStopGhost();
}
function startGhost(){
  wiringStopGhost();
  wiring.ghost = document.createElementNS('http://www.w3.org/2000/svg','line');
  wiring.ghost.setAttribute('stroke','#9ca3af'); wiring.ghost.setAttribute('stroke-width','2'); wiring.ghost.setAttribute('stroke-dasharray','4 4');
  svg.appendChild(wiring.ghost);
}
function wiringStopGhost(){ if(wiring.ghost){ wiring.ghost.remove(); wiring.ghost=null; } }
stage.addEventListener('pointermove',(e)=>{
  if(!wiring.active || !wiring.ghost || !wiring.source) return;
  const p=pointerToWorld(e);
  const c=centerInWorld(wiring.source);
  wiring.ghost.setAttribute('x1',c.x); wiring.ghost.setAttribute('y1',c.y);
  wiring.ghost.setAttribute('x2',p.wx); wiring.ghost.setAttribute('y2',p.wy);
});
document.addEventListener('keydown',(e)=>{ if(e.key.toLowerCase()==='c'){ wiring.active? wiringStop(): wiringStart(currentNode||mainNode); } if(e.key==='Escape'){ wiringStop(); } });
wireModeBtn.addEventListener('click',()=>{ wiring.active? wiringStop():wiringStart(currentNode||mainNode); });
stage.addEventListener('click',(e)=>{ if(wiring.active && !e.target.closest('.node')){ wiringStop(); } });

/* Suppression n≈ìud */
function deleteNode(node){
  if(node===mainNode){ alert('Le c≈ìur ne peut pas √™tre supprim√©.'); return; }
  // Supprimer lignes li√©es
  qLines().forEach(l=>{ if(l.dataset.from===node.dataset.id||l.dataset.to===node.dataset.id) l.remove(); });
  // Supprimer t√¢ches li√©es
  for(let i=tasks.length-1;i>=0;i--){ if(tasks[i].nodeId===node.dataset.id) tasks.splice(i,1); }
  node.remove();
  if(currentNode===node) currentNode=null;
  saveState(); refreshSidebar();
}

/* Centrer la vue sur un n≈ìud */
function centerViewOn(node){
  // Centre le n≈ìud au milieu du stage
  const r=stageRect();
  const c=centerInWorld(node);
  camera.x = (r.width/2) - c.x*camera.z;
  camera.y = (r.height/2) - c.y*camera.z;
  applyCamera();
  flash(node);
}

/* Menu 1 (liste principaux & secondaires) */
function refreshSidebar(){
  principalList.innerHTML='';
  const principals=[...world.querySelectorAll('.node')].filter(isPrincipalNode);
  principals.forEach(n=>{
    const wrap=document.createElement('div');
    const btn=document.createElement('button');
    btn.className='side-item'; btn.type='button';
    btn.textContent = n.querySelector('.label')?.textContent || n.dataset.id;
    const ul=document.createElement('ul'); ul.className='child-list'; ul.style.display='none';
    btn.addEventListener('click',()=>{
      openMenu2For(n);
      if(ul.style.display==='none'){ populateChildren(n.dataset.id, ul); ul.style.display='block'; }
      else { ul.style.display='none'; }
      flash(n);
    });
    wrap.appendChild(btn); wrap.appendChild(ul); principalList.appendChild(wrap);
  });
}
function populateChildren(principalId, container){
  container.innerHTML='';
  const ids=neighborsOf(principalId);
  const seconds=ids.map(id=>world.querySelector(`[data-id="${id}"]`)).filter(Boolean).filter(isSecondaryNode);
  if(seconds.length===0){
    const li=document.createElement('li'); li.textContent='Aucun cercle secondaire'; li.style.color='#6b7280'; li.style.borderStyle='dashed';
    container.appendChild(li); return;
  }
  seconds.forEach(n=>{
    const li=document.createElement('li'); li.textContent=n.querySelector('.label')?.textContent||n.dataset.id;
    li.addEventListener('click',()=>{ setCurrentNode(n); centerViewOn(n); flash(n); });
    container.appendChild(li);
  });
}

/* T√¢ches */
let tasks=[]; // {id, nodeId, title, desc, createdAt}
function updateTaskBadges(){ world.querySelectorAll('.node').forEach(addBadges); }
function openTaskEditor(node, taskId=null){
  editingTaskCtx = taskId? { node, taskId } : { node, taskId:null };
  taskEditorTitle.textContent = `T√¢ches de: ${node.querySelector('.label')?.textContent||node.dataset.id}`;
  taskTitle.value = ''; taskDesc.value='';
  if(taskId){
    const t=tasks.find(t=>t.id===taskId); if(t){ taskTitle.value=t.title; taskDesc.value=t.desc||''; }
  }
  renderNodeTasksList(node);
  taskEditor.style.display='flex';
}
function closeTaskEditor(){ taskEditor.style.display='none'; editingTaskCtx=null; }
function renderNodeTasksList(node){
  nodeTasksList.innerHTML='';
  const list=tasks.filter(t=>t.nodeId===node.dataset.id);
  if(list.length===0){
    const d=document.createElement('div'); d.style.color='#6b7280'; d.textContent='Aucune t√¢che.';
    nodeTasksList.appendChild(d); return;
  }
  list.forEach(t=>{
    const item=document.createElement('div'); item.className='task-item';
    item.innerHTML = `<div class="task-line"><strong>${escapeHtml(t.title)}</strong><span class="task-actions">
      <button class="icon-btn small" title="√âditer">‚úèÔ∏è</button>
      <button class="icon-btn small" title="Supprimer">üóëÔ∏è</button></span></div>
      ${t.desc? `<small>${escapeHtml(t.desc)}</small>`:''}`;
    const [editBtn, delBtn]=item.querySelectorAll('.icon-btn.small');
    editBtn.addEventListener('click',()=>{ openTaskEditor(node, t.id); });
    delBtn.addEventListener('click',()=>{ if(confirm('Supprimer cette t√¢che ?')){ tasks=tasks.filter(x=>x.id!==t.id); saveState(); renderNodeTasksList(node); updateTaskBadges(); renderTasksGlobal(); } });
    nodeTasksList.appendChild(item);
  });
}
taskSave.addEventListener('click',()=>{
  if(!editingTaskCtx) return;
  const node=editingTaskCtx.node;
  const title=taskTitle.value.trim();
  if(!title){ alert('Titre requis'); return; }
  const desc=taskDesc.value.trim();
  if(editingTaskCtx.taskId){
    const t=tasks.find(t=>t.id===editingTaskCtx.taskId);
    if(t){ t.title=title; t.desc=desc; }
  }else{
    const id='task-'+Math.random().toString(36).slice(2,9);
    tasks.push({id,nodeId:node.dataset.id,title,desc,createdAt:Date.now()});
  }
  saveState(); renderNodeTasksList(node); updateTaskBadges(); renderTasksGlobal();
  taskTitle.value=''; taskDesc.value='';
});
taskCancel.addEventListener('click', closeTaskEditor);

/* Liste globale */
tasksBtn.addEventListener('click',()=>{ renderTasksGlobal(); tasksModal.style.display='flex'; });
tasksClose.addEventListener('click',()=> tasksModal.style.display='none');
function renderTasksGlobal(){
  tasksContainer.innerHTML='';
  if(tasks.length===0){ const d=document.createElement('div'); d.style.color='#6b7280'; d.textContent='Aucune t√¢che.'; tasksContainer.appendChild(d); return; }
  tasks.forEach(t=>{
    const node=world.querySelector(`[data-id="${t.nodeId}"]`);
    const name=node? (node.querySelector('.label')?.textContent||node.dataset.id) : t.nodeId;
    const item=document.createElement('div'); item.className='task-item';
    item.innerHTML = `<div class="task-line"><strong>${escapeHtml(t.title)}</strong><small> ‚Äî ${escapeHtml(name)}</small>
      <span class="task-actions"><button class="icon-btn small" title="√âditer">‚úèÔ∏è</button><button class="icon-btn small" title="Supprimer">üóëÔ∏è</button></span></div>
      ${t.desc? `<small>${escapeHtml(t.desc)}</small>`:''}`;
    const [editBtn, delBtn]=item.querySelectorAll('.icon-btn.small');
    editBtn.addEventListener('click',()=>{ if(node){ tasksModal.style.display='none'; openTaskEditor(node, t.id); } });
    delBtn.addEventListener('click',()=>{ if(confirm('Supprimer cette t√¢che ?')){ tasks=tasks.filter(x=>x.id!==t.id); saveState(); renderTasksGlobal(); updateTaskBadges(); } });
    tasksContainer.appendChild(item);
  });
}

/* Toolbar / Fichier */
exportBtn.addEventListener('click',()=>{
  const data = buildState();
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='workspace.json'; a.click(); URL.revokeObjectURL(url);
});
importBtn.addEventListener('click',()=> fileInput.click());
fileInput.addEventListener('change', async (e)=>{
  const file=e.target.files?.[0]; if(!file) return;
  try{ const txt=await file.text(); restoreState(JSON.parse(txt)); } catch{ alert('Fichier invalide.'); }
  finally{ fileInput.value=''; }
});
resetBtn.addEventListener('click',()=>{
  if(!confirm('R√©initialiser l‚Äôespace de travail ?')) return;
  localStorage.removeItem('workspaceState');
  // reset tout
  qLines().forEach(l=>l.remove());
  world.querySelectorAll('.node').forEach(n=>{ if(n!==mainNode) n.remove(); });
  // Remet le c≈ìur au centre de la vue (0,0) + camera au centre √©cran
  mainNode.style.left='0px'; mainNode.style.top='0px'; mainNode.style.backgroundColor='var(--primary)';
  mainNode.querySelector('.label').textContent='Cercle principal';
  mainNode.dataset.maxFont='32'; fitLabelToNode(mainNode);
  tasks.length=0;
  currentNode=null; menu2Locked=false; actionsPanel.style.display='none';
  idCounter=1;
  // recadre cam√©ra pour voir le c≈ìur au centre √©cran
  const r=stageRect(); camera.x = r.width/2; camera.y = r.height/2; camera.z=1; // car c≈ìur √† (0,0), on place la cam√©ra telle que monde (0,0) au centre
  applyCamera();
  saveState(); refreshSidebar(); updateTaskBadges(); updateAllLines();
});

/* Home (recentrer sur le c≈ìur) */
homeBtn.addEventListener('click',()=> centerViewOn(mainNode));

/* Fermeture menus contextuels si clic ext√©rieur */
document.addEventListener('contextmenu',(e)=>{ if(!e.target.closest('.node')) closeMenus(); });

/* Zone sch√©ma : ne pas fermer Menu 2 en cliquant */
stage.addEventListener('mousedown',(e)=>{ /* no-op pour menu2; on ne le ferme pas */ });

/* ========== Persistance ========== */
function buildState(){
  const nodes=[...world.querySelectorAll('.node')].map(n=>({
    id: n.dataset.id,
    left: parseFloat(n.style.left)||n.offsetLeft||0,
    top: parseFloat(n.style.top)||n.offsetTop||0,
    w: n.offsetWidth,
    h: n.offsetHeight,
    text: n.querySelector('.label')?.textContent || '',
    color: toHex(getComputedStyle(n).backgroundColor) || '#CC0000',
    fontFamily: n.querySelector('.label')?.style.fontFamily || '',
    fontWeight: n.querySelector('.label')?.style.fontWeight || '',
    fontStyle: n.querySelector('.label')?.style.fontStyle || '',
    textDecoration: n.querySelector('.label')?.style.textDecoration || '',
    maxFont: n.dataset.maxFont ? parseFloat(n.dataset.maxFont) : 32,
    url: n.dataset.url || ''
  }));
  const edges=[...qLines()].map(l=>({from:l.dataset.from, to:l.dataset.to}));
  return { nodes, edges, idCounter, tasks, camera };
}
function saveState(){
  localStorage.setItem('workspaceState', JSON.stringify(buildState()));
  refreshSidebar();
  updateTaskBadges();
}
function restoreState(data){
  // Clear
  qLines().forEach(l=>l.remove());
  world.querySelectorAll('.node').forEach(n=>{ if(n!==mainNode) n.remove(); });
  // Camera
  if(data.camera){ camera.x=data.camera.x||0; camera.y=data.camera.y||0; camera.z=data.camera.z||1; applyCamera(); }
  // Nodes
  const byId={};
  (data.nodes||[]).forEach(n=>{
    let node;
    if(n.id==='node-0'){ node=mainNode; }
    else { node=createNode({x:n.left,y:n.top,w:n.w,h:n.h,text:n.text,color:n.color}); node.dataset.id=n.id; }
    node.style.left = n.left+'px'; node.style.top = n.top+'px';
    node.style.width = n.w+'px'; node.style.height = n.h+'px';
    node.style.backgroundColor = n.color || '#CC0000';
    const label=node.querySelector('.label');
    label.textContent = n.text || '';
    if(n.fontFamily) label.style.fontFamily=n.fontFamily;
    if(n.fontWeight) label.style.fontWeight=n.fontWeight;
    if(n.fontStyle) label.style.fontStyle=n.fontStyle;
    if(n.textDecoration) label.style.textDecoration=n.textDecoration;
    node.dataset.maxFont = String(n.maxFont||32);
    if(n.url) node.dataset.url = n.url; else delete node.dataset.url;
    fitLabelToNode(node);
    addBadges(node);
    enableNode(node);
    byId[n.id]=node;
  });
  // Ensure c≈ìur
  if(!byId['node-0']){ byId['node-0']=mainNode; mainNode.dataset.id='node-0'; mainNode.querySelector('.label').textContent='Cercle principal'; }
  // Edges
  (data.edges||[]).forEach(e=>{ if(byId[e.from] && byId[e.to]) createLine(byId[e.from], byId[e.to]); });
  updateAllLines();
  // idCounter
  idCounter = data.idCounter || (Math.max(0, ...Object.keys(byId).map(id=>parseInt(id.split('-')[1]||'0',10)))+1);
  idCounterInitDone=true;
  // Tasks
  tasks = Array.isArray(data.tasks)? data.tasks : [];
  updateTaskBadges();
  refreshSidebar();
  localStorage.setItem('workspaceState', JSON.stringify(buildState()));
}

/* ========== Utilitaires divers ========== */
function toFront(node){ world.appendChild(node); }

/* Initialisation */
function init(){
  // Place le c≈ìur au centre √©cran
  const r=stageRect(); camera.x = r.width/2; camera.y = r.height/2; camera.z=1; applyCamera();
  enableNode(mainNode);
  mainNode.dataset.maxFont='32'; fitLabelToNode(mainNode);
  // Restaure si pr√©sent
  const saved=localStorage.getItem('workspaceState');
  if(saved){ try{ restoreState(JSON.parse(saved)); }catch{} }
  else { saveState(); }
}
init();

/* ========== Aides suppl√©mentaires ========== */
function renderMenu3OpenUrlState(){
  const url=currentNode?.dataset?.url||'';
  if(url){ openUrlBtnMenu.href=url; openUrlBtnMenu.style.opacity='1'; openUrlBtnMenu.style.pointerEvents='auto'; }
  else { openUrlBtnMenu.removeAttribute('href'); openUrlBtnMenu.style.opacity='.4'; openUrlBtnMenu.style.pointerEvents='none'; }
}
</script>
</body>
</html>
